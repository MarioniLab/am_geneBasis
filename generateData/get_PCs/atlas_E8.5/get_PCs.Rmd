---
title: "This script is dedicated to get PC coordinates for gene matrix for different set of features."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Atlas - E8.5


```{r load, message = FALSE}
# load libraries we are going to use


library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(pheatmap)
library(reshape2)
library(edgeR)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
library(tibble)
set.seed(32)

root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
save.dir = paste0(root.dir , "data/PCs/atlas_E8.5/")
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
sce = readRDS(paste0( root.dir, "data/scRNA_datasets/atlas_E8.5/sce_atlas_E8.5.Rds"))
rownames(sce) = rowData(sce)[,1]

# assign reference sample
reference.bool = sapply(1:ncol(sce), function(i){
  if (sce$sample[i] == 29){
    return(T)
  } else {
    return(F)
  }
})
sce$reference = reference.bool


# delete v rare CTs
tab = table(sce$celltype[sce$reference])
CTs.2keep = names(tab)[tab >= 5]
sce = sce[, sce$celltype %in% CTs.2keep] 


# get suitable for seq genes
genes.4seq = get_suitable4seq_genes(dir = "cluster", system = "atlas_E8.5" , mean.thresh = 7, max.thresh = 350)

get_PCs = function(genes , sce){
  current.sce = sce[rownames(sce) %in% genes, ]
  current.counts = cosineNorm(logcounts(current.sce))
  batchFactor = factor(c(as.character(current.sce$sample)))
  mbpca = multiBatchPCA(current.counts, batch = batchFactor, d = 100)
  mbpca = do.call(rbind , mbpca)
  return(mbpca)
}


```

# All HVGs

```{r pc-HVGs, message = FALSE}
# 
# 
# HVGs = getHVGs(sce , dir = "cluster")
# HVGs = intersect(HVGs , genes.4seq)
# mbpca = get_PCs(HVGs, sce)
# saveRDS(mbpca , file =  paste0( save.dir, "PC_HVGs.Rds"))


```

# Markers 

## Binomial test

```{r pc-all-binom, message = FALSE}
# 
# markers = read.table(paste0(root.dir , "data/markers/atlas_E8.5/markers__binom.tab") , header = T, sep = "\t")
# markers = unique(markers$gene)
# markers = intersect(markers , genes.4seq)
# mbpca = get_PCs(markers, sce)
# saveRDS(mbpca , file =  paste0( save.dir, "PC_binom_all.Rds"))

```

## T-test

```{r pc-all-t, message = FALSE}

# 
# markers = read.table(paste0(root.dir , "data/markers/atlas_E8.5/markers__t.tab") , header = T, sep = "\t")
# markers = unique(markers$gene)
# markers = intersect(markers , genes.4seq)
# mbpca = get_PCs(markers, sce)
# saveRDS(mbpca , file =  paste0( save.dir, "PC_t_all.Rds"))


```

# PCA based

## Binom

```{r pc-pcaBased-binom, message = FALSE}
# 
# 
# nPC.grid = seq(10,180,10) 
# genes.dirs = paste0("binom_", c("scaled_unweighted",  "scaled_weighted" , "unscaled_unweighted",  "unscaled_weighted"))
# 
# pcs.all = lapply(genes.dirs , function(genes.dir){
#   genes = read.table(paste0(root.dir , "data/gene_ranking/atlas_E8.5/" , genes.dir, ".tab"), header = T , sep = "\t")
#   pcs = lapply(nPC.grid , function(nPC){
#     current.genes = genes$gene[1:nPC]
#     current.pcs = get_PCs(current.genes , sce)
#     return(current.pcs)
#   })
#   names(pcs) = paste0("nGenes_" , nPC.grid)
#   saveRDS(pcs , file = paste0(save.dir, genes.dir, ".Rds"))
# })

```

## T

```{r pc-pcaBased-t, message = FALSE}

# 
# nPC.grid = seq(10,180,10) 
# genes.dirs = paste0("t_", c("scaled_unweighted",  "scaled_weighted" , "unscaled_unweighted",  "unscaled_weighted"))
# 
# pcs.all = lapply(genes.dirs , function(genes.dir){
#   genes = read.table(paste0(root.dir , "data/gene_ranking/atlas_E8.5/" , genes.dir, ".tab"), header = T , sep = "\t")
#   pcs = lapply(nPC.grid , function(nPC){
#     current.genes = genes$gene[1:nPC]
#     current.pcs = get_PCs(current.genes , sce)
#     return(current.pcs)
#   })
#   names(pcs) = paste0("nGenes_" , nPC.grid)
#   saveRDS(pcs , file = paste0(save.dir, genes.dir, ".Rds"))
# })

```


# scGene-Fit

## Binom

```{r pc-scgenefit-binom, message = FALSE}

# 
# nPC.grid = seq(10,180,10)
# genes.dir = paste0(root.dir , "data/gene_ranking/atlas_E8.5/binom_pairwise_centers/")
# 
# 
# pcs = lapply(nPC.grid , function(nPC){
#   current.genes = read.table(paste0(genes.dir , "num_markers__" , nPC, ".tab"), header = F , sep = "\t")
#   current.genes = current.genes$V1
#   current.pcs = get_PCs(current.genes , sce)
#   return(current.pcs)
#   saveRDS(pcs , file = paste0(save.dir, genes.dir, ".Rds"))
# })
# names(pcs) = paste0("nGenes_" , nPC.grid)
# saveRDS(pcs , file = paste0(save.dir, "binom_pairwise_centers", ".Rds"))


```

## T

```{r pc-scgenefit-t, message = FALSE}

# 
# nPC.grid = seq(10,180,10)
# genes.dir = paste0(root.dir , "data/gene_ranking/atlas_E8.5/t_pairwise_centers/")
# 
# 
# pcs = lapply(nPC.grid , function(nPC){
#   current.genes = read.table(paste0(genes.dir , "num_markers__" , nPC, ".tab"), header = F , sep = "\t")
#   current.genes = current.genes$V1
#   current.pcs = get_PCs(current.genes , sce)
#   return(current.pcs)
#   saveRDS(pcs , file = paste0(save.dir, genes.dir, ".Rds"))
# })
# names(pcs) = paste0("nGenes_" , nPC.grid)
# saveRDS(pcs , file = paste0(save.dir, "t_pairwise_centers", ".Rds"))


```

# Random

## Binom

```{r pc-rand-binom, message = FALSE}

markers = read.table(paste0(root.dir , "data/markers/atlas_E8.5/markers__binom.tab") , header = T, sep = "\t")
markers = unique(markers$gene)
markers = intersect(markers , genes.4seq)

nPC.grid = seq(10,180,10)
K = 5

pcs = lapply(1:K , function(i){
  genes = sample(markers , 180)
  pcs.current_rand = lapply(nPC.grid , function(nPC){
    current.genes = genes[1:nPC]
    current.pcs = get_PCs(current.genes , sce)
    return(current.pcs)
  })
  names(pcs.current_rand) = paste0("nGenes_" , nPC.grid)
  saveRDS(pcs.current_rand , file = paste0(save.dir, "binom_rand_" , i, ".Rds"))
})


```

## T

```{r pc-rand-t, message = FALSE}


markers = read.table(paste0(root.dir , "data/markers/atlas_E8.5/markers__t.tab") , header = T, sep = "\t")
markers = unique(markers$gene)
markers = intersect(markers , genes.4seq)

nPC.grid = seq(10,180,10)
K = 5

pcs = lapply(1:K , function(i){
  genes = sample(markers , 180)
  pcs.current_rand = lapply(nPC.grid , function(nPC){
    current.genes = genes[1:nPC]
    current.pcs = get_PCs(current.genes , sce)
    return(current.pcs)
  })
  names(pcs.current_rand) = paste0("nGenes_" , nPC.grid)
  saveRDS(pcs.current_rand , file = paste0(save.dir, "t_rand_" , i, ".Rds"))
})


```


#Session Info

```{r sessinf}
sessionInfo()
```
