---
title: "Pipeline to benchmark selections: geneBasis, SCMER, scGeneFit (marker selection) for cell score"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(batchelor)
library(stats)
library(BiocNeighbors)
library(tibble)
library(reshape2)
library(plyr)
library(dplyr)
library(scran)
library(batchelor)
library(stringr)
library(BiocSingular)
library(BiocParallel)
library(SingleCellExperiment)
library(BiocStyle)
ncores = 7
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)

#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/functions/main_functions.R"))

system = "pancreas"

# read sce 
sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))
sce$cell = colnames(sce)

```


# Get gene selections

## geneBasis

```{r read-selection-gene-basis, message = FALSE}

genes_alsu = readRDS(paste0(root.dir , "data/gene_selection/" , system , "/" , "gene_selection.Rds"))
genes_alsu = as.character(genes_alsu$gene)
n_genes.grid = seq(10,250,10)

```

# Celltype mapping

```{r celltype-mapping, message = FALSE}



get_celltypes_stat = function(sce , genes , batch = "sample", n.neigh = 5){
  nPC = 50
  neighs = suppressWarnings( get_mapping(sce , genes = genes, batch = batch, n.neigh = n.neigh, nPC = nPC , get.dist = F , type = "together"))
  if (!is.null(neighs)){
    meta = as.data.frame(colData(sce))
    current.mapping = data.frame(cell = rownames(neighs) ,
                                 celltype = sapply(1:nrow(neighs) , function(i) meta$celltype[meta$cell == rownames(neighs)[i]]) ,
                                 mapped_celltype = sapply(1:nrow(neighs), function(i) getmode(meta$celltype[match(neighs[i,] , meta$cell)] , 1:n.neigh) ))
    current.stat = get_fraction_mapped_correctly(current.mapping)
    return(current.stat)
  }
  else {
    return(NULL)
  }
}


```

## Get redundancy stat

```{r score-vs-scmer-batched, message = FALSE}



stat = bplapply(n_genes.grid , function(n_genes){
  current.genes = genes[1:n_genes]
  stat.all = get_celltypes_stat = function(sce , genes = current.genes, batch = "sample", n.neigh = 5)
  colnames(stat.all) = c("celltype" , "frac_correctly_mapped_all")  
  stat.per_gene = lapply(current.genes , function(gene){
    current.stat = get_celltypes_stat = function(sce , genes = setdiff(current.genes,gene) , batch = "sample", n.neigh = 5)
    current.stat$gene = gene  
  })
  stat.per_gene = do.call(rbind , stat.per_gene)
  stat.per_gene = merge(stat.per_gene , stat.all , all.x = T)
  stat.per_gene$frac.ratio = stat.per_gene$frac_correctly_mapped/stat.per_gene$frac_correctly_mapped_all
  stat.per_gene$n_genes = n_genes
  return(stat.per_gene)
}, BPPARAM = mcparam)
stat = do.call(rbind , stat)
saveRDS(stat , file = paste0(root.dir , "data/redundancy/" , system , "/redundancy_celltypes.Rds"))

```


# Session Info

```{r sessinf}
sessionInfo()
```
