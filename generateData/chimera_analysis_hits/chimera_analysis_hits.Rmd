---
title: "Pipeline to choose metric (hopefully lol) for final gene selection."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(ggplot2)
library(ggpubr)
library(batchelor)
library(stats)
library(BiocNeighbors)
library(tibble)
library(reshape2)
library(plyr)
library(dplyr)
library(scran)
library(batchelor)
library(stringr)
library(BiocSingular)
library(scater)
library(BiocStyle)
library(BiocParallel)
library(stats)
ncores = 1
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)

#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/functions/main_functions.R"))
source(paste0(root.dir, "am_geneBasis/functions/visualization_functions.R"))

# read sce 
system = "atlas_E8.5"
print("1")
sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))
rownames(sce) = rowData(sce)[,2]
print("2")
# add rowdata w normal gene names
rowdata = as.data.frame(rowData(sce))
colnames(rowdata) = c("gene" , "gene_symbol")
print("3")

```

# check

```{r co-expr-hits, message = FALSE}
# read gene selection
genes_atlas_E8.5 = readRDS(paste0(root.dir , "data/gene_selection/" , "atlas_E8.5" , "/gene_selection.Rds"))
genes_atlas_E8.5 = merge(genes_atlas_E8.5 , rowdata )
genes_atlas_E8.5 = genes_atlas_E8.5[, c( "gene_symbol" , "rank")]
colnames(genes_atlas_E8.5) = c("gene" , "rank")
genes_atlas_E8.5 = genes_atlas_E8.5[order(genes_atlas_E8.5$rank) , ]
print("2")

genes_WT_chimera_false = readRDS(paste0(root.dir , "data/gene_selection/" , "atlas_E8.5_chimera_WT" , "/gene_selection_TRUE.Rds"))
genes_WT_chimera_false = merge(genes_WT_chimera_false , rowdata )
genes_WT_chimera_false = genes_WT_chimera_false[, c( "gene_symbol" , "rank")]
colnames(genes_WT_chimera_false) = c("gene" , "rank")
genes_WT_chimera_false = genes_WT_chimera_false[order(genes_WT_chimera_false$rank) , ]
print("3")

genes_WT_chimera_true = readRDS(paste0(root.dir , "data/gene_selection/" , "atlas_E8.5_chimera_WT" , "/gene_selection_FAlSE.Rds"))
genes_WT_chimera_true = merge(genes_WT_chimera_true , rowdata )
genes_WT_chimera_true = genes_WT_chimera_true[, c( "gene_symbol" , "rank")]
colnames(genes_WT_chimera_true) = c("gene" , "rank")
genes_WT_chimera_true = genes_WT_chimera_true[order(genes_WT_chimera_true$rank) , ]
print("4")

genes_tal1_chimera_true = readRDS(paste0(root.dir , "data/gene_selection/" , "atlas_E8.5_tal1" , "/gene_selection_TRUE.Rds"))
genes_tal1_chimera_true = merge(genes_tal1_chimera_true , rowdata )
genes_tal1_chimera_true = genes_tal1_chimera_true[, c( "gene_symbol" , "rank")]
colnames(genes_tal1_chimera_true) = c("gene" , "rank")
genes_tal1_chimera_true = genes_tal1_chimera_true[order(genes_tal1_chimera_true$rank) , ]
print("5")

genes_tal1_chimera_false = readRDS(paste0(root.dir , "data/gene_selection/" , "atlas_E8.5_tal1" , "/gene_selection_FALSE.Rds"))
genes_tal1_chimera_false = merge(genes_tal1_chimera_false , rowdata )
genes_tal1_chimera_false = genes_tal1_chimera_false[, c( "gene_symbol" , "rank")]
colnames(genes_tal1_chimera_false) = c("gene" , "rank")
genes_tal1_chimera_false = genes_tal1_chimera_false[order(genes_tal1_chimera_false$rank) , ]
print("6")


```

# Get co-expression patterns for interesting hits

```{r co-expr-hits, message = FALSE}

genes = c("Cbx" , "Ccng1" , "Rpgrip1" , "Slc24a5")

systems = c("atlas_E8.5_chimera_WT" , "atlas_E8.5_tal1")
corr_stat = lapply(systems , function(system){
  sce_system = sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_" , system  , ".Rds"))
  stat_per_system = lapply(c(T,F) , function(bool){
    current.sce = sce_system[, sce_system$tomato == bool]
    rownames(current.sce) = rowData(current.sce)[,2]
    current.sce = retain_only_hvgs(current.sce , n=10000)
    
    current.stat = lapply(genes , function(gene){
      current.log = as.numeric(logcounts(current.sce[gene , ]))
      out = bplapply(1:nrow(current.sce) , function(j){
        return(data.frame(gene = rownames(current.sce)[j] , corr = cor(as.numeric(logcounts(current.sce[j , ])) , current.log)))
      }, BPPARAM = mcparam)
      out = do.call(rbind , out)
      out = out[out$corr < 1]
      out = out[order(out$corr, decreasing = T) , ]
      out$original.gene = current.gene
      return(out[1:50,])
    })
    current.stat = do.call(rbind , current.stat)
    current.stat$bool = bool
    return(current.stat)
  })
  stat_per_system = do.call(rbind ,stat_per_system)
  stat_per_system$system = system
  return(stat_per_system)
})
corr_stat = do.call(rbind , corr_stat)
saveRDS(corr_stat , paste0(root.dir , "data/chimera_stat/corr_stat_hits.Rds"))



```









# Session Info

```{r sessinf}
sessionInfo()
```
