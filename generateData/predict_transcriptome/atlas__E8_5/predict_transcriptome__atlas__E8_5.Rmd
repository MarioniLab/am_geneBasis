---
title: "Prediction of transcriptome - atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

#Introduction & method


```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
ncores = 10
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)


root.dir = "/Users/alsu/Develop/geneBasis/"
#root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
sce = readRDS(paste0( root.dir, "data/atlas__8_5/sce_atlas_8.5.Rds"))

genes.info = as.data.frame(rowData(sce))

reference.bool = sapply(1:ncol(sce), function(i){
  if (sce$sample[i] == 29){
    return(T)
  } else {
    return(F)
  }
})
sce$reference = reference.bool

tab = table(sce$celltype[sce$reference])
CTs.2keep = names(tab)[tab > 10]
sce = sce[, sce$celltype %in% CTs.2keep] 

# assign ENSEMBL names
rownames(sce) = rowData(sce)[,1]

unq.markers = read.table(paste0(root.dir , "data/markers/" , "markers__atlas_E8_5" , ".tab"), header = T , sep = "\t")
unq.markers = unique(unq.markers$gene)

sce = sce[rownames(sce) %in% unq.markers , ]
meta = as.data.frame(colData(sce))


# read mappings
mappings.dir = paste0(root.dir , "data/mappings/atlas__E8_5/")

mappings.unweighted_unscaled__twoRounds = readRDS(paste0(mappings.dir , "unweighted_unscaled__twoRounds.Rds"))
mappings.weighted_unscaled__twoRounds = readRDS(paste0(mappings.dir , "weighted_unscaled__twoRounds.Rds"))
mappings.bianca.pairwise_centers = readRDS(paste0(mappings.dir , "bianca__pairwise_centers.Rds"))
mappings.all = readRDS(paste0(mappings.dir , "all_markers.Rds"))


```

# Get transcriptome

```{r predict-transcriptome , message = FALSE}



updateMapping = function(mapping){
  mapping$V1 = as.character(mapping$V1)
  mapping$V2 = as.character(mapping$V2)
  mapping$V3 = as.character(mapping$V3)
  mapping$V4 = as.character(mapping$V4)
  mapping$V5 = as.character(mapping$V5)
  mapping$V6 = as.character(mapping$V6)
  mapping$V7 = as.character(mapping$V7)
  mapping$V8 = as.character(mapping$V8)
  mapping$V9 = as.character(mapping$V9)
  mapping$V10 = as.character(mapping$V10)
  return(mapping)
}


logcounts = as.matrix(logcounts(sce))
cols.cells = paste0("V" , c(1:10))

getCorrTranscriptome = function(mapping){
  if (class(mapping) == "list"){
    stat.per_nGenes = lapply(c(1,9,19), function(current.mapping.id){
      print(current.mapping.id)
      current.mapping = mapping[[current.mapping.id]]
      current.mapping = updateMapping(current.mapping)
      logcounts.estimated = lapply(1:nrow(current.mapping), function(i){
        cells = current.mapping[i , cols.cells]
        current.logcounts = logcounts[, colnames(logcounts) %in% cells]
        return(apply(current.logcounts , 1 , mean))
      })
      logcounts.estimated = do.call(cbind , logcounts.estimated)
      colnames(logcounts.estimated) = current.mapping$cell
      
      logcounts.real = logcounts[, colnames(logcounts) %in% current.mapping$cell]
      logcounts.estimated = logcounts.estimated[, order(colnames(logcounts.estimated))]
      logcounts.real = logcounts.real[, order(colnames(logcounts.real))]
      
      stat = lapply(rownames(logcounts.real), function(gene){
        out = data.frame(gene = gene , corr = cor(logcounts.real[gene,] , logcounts.estimated[gene,] , method = "pearson"))
      })
      stat = do.call(rbind, stat)
      stat$n.genes = current.mapping$n.genes[1]
      return(stat)
    })
    stat.per_nGenes = do.call(rbind , stat.per_nGenes)
    return(stat.per_nGenes)
  } 
  else {
    current.mapping = mapping
    current.mapping = updateMapping(current.mapping)
    logcounts.estimated = lapply(1:nrow(current.mapping), function(i){
        cells = current.mapping[i , cols.cells]
        current.logcounts = logcounts[, colnames(logcounts) %in% cells]
        return(apply(current.logcounts , 1 , mean))
      })
      logcounts.estimated = do.call(cbind , logcounts.estimated)
      colnames(logcounts.estimated) = current.mapping$cell
      
      logcounts.real = logcounts[, colnames(logcounts) %in% current.mapping$cell]
      logcounts.estimated = logcounts.estimated[, order(colnames(logcounts.estimated))]
      logcounts.real = logcounts.real[, order(colnames(logcounts.real))]
      
      stat = lapply(rownames(logcounts.real), function(gene){
        out = data.frame(gene = gene , corr = cor(logcounts.real[gene,] , logcounts.estimated[gene,] , method = "pearson"))
      })
      stat = do.call(rbind, stat)
      stat$n.genes = current.mapping$n.genes[1]
    return(stat)
  }
}


stat.corr.weighted_unscaled__twoRounds = getCorrTranscriptome(mappings.weighted_unscaled__twoRounds)
saveRDS(stat.corr.weighted_unscaled__twoRounds , file = paste0(root.dir, "data/corr_stat/atlas__E8_5/weighted_unscaled__twoRounds.Rds"))

stat.corr.unweighted_unscaled__twoRounds = getCorrTranscriptome(mappings.unweighted_unscaled__twoRounds)
saveRDS(stat.corr.unweighted_unscaled__twoRounds , file = paste0(root.dir, "data/corr_stat/atlas__E8_5/unweighted_unscaled__twoRounds.Rds"))

stat.corr.bianca.pairwise_centers = getCorrTranscriptome(mappings.bianca.pairwise_centers)
saveRDS(stat.corr.bianca.pairwise_centers , file = paste0(root.dir, "data/corr_stat/atlas__E8_5/bianca.pairwise_centers.Rds"))

stat.corr.all = getCorrTranscriptome(mappings.all)
saveRDS(stat.corr.all , file = paste0(root.dir, "data/corr_stat/atlas__E8_5/all.Rds"))


```




#Session Info

```{r sessinf}
sessionInfo()
```
