---
title: "Prediction of transcriptome - atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

#Introduction & method


```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
ncores = 1
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)

system = "atlas_E8.5"
#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
sce = readRDS(paste0( root.dir, "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))
rownames(sce) = rowData(sce)[,1]

reference.bool = sapply(1:ncol(sce), function(i){
  if (sce$sample[i] == 29){
    return(T)
  } else {
    return(F)
  }
})
sce$reference = reference.bool
tab = table(sce$celltype[sce$reference])
CTs.2keep = names(tab)[tab > 5]
sce = sce[, sce$celltype %in% CTs.2keep] 

# get suitable for seq genes
genes.4seq = get_suitable4seq_genes(dir = "cluster", system = system , mean.thresh = 7, max.thresh = 350)

# load markers
markers.binom = read.table(paste0(root.dir , "data/markers/" , system , "/markers__binom.tab") , header = T, sep = "\t")
markers.binom = unique(markers.binom$gene)
markers.binom = intersect(markers.binom , genes.4seq)

markers.t = read.table(paste0(root.dir , "data/markers/" , system , "/markers__t.tab") , header = T, sep = "\t")
markers.t = unique(markers.t$gene)
markers.t = intersect(markers.t , genes.4seq)


# read mappings
mappings.dir = paste0(root.dir , "data/mappings/" , system , "/")
types = c("t_unscaled_unweighted" , "t_unscaled_weighted" , "t_pairwise_centers" , "t_all" , "t_rand_1" , "t_rand_2" , "t_rand_3" , "t_rand_4" , "t_rand_5")

mappings = lapply(types , function(type){
  current.mapping = readRDS(paste0(mappings.dir , type , ".Rds"))
  return(current.mapping)
})
names(mappings) = types


```

# Get transcriptome

```{r predict-transcriptome , message = FALSE}


cols.cells = paste0("V" , c(1:10))
getCorrTranscriptome_oneMapping = function(mapping , genes){
  current.sce = sce[rownames(sce) %in% genes , ]
  logcounts = as.matrix(logcounts(current.sce))
  logcounts.estimated = lapply(1:nrow(mapping), function(i){
    cells = mapping[i , cols.cells]
    current.logcounts = logcounts[, colnames(logcounts) %in% cells]
    return(apply(current.logcounts , 1 , mean))
  })
  logcounts.estimated = do.call(cbind , logcounts.estimated)
  colnames(logcounts.estimated) = mapping$cell
  logcounts.real = logcounts[, colnames(logcounts) %in% mapping$cell]
  logcounts.estimated = logcounts.estimated[, order(colnames(logcounts.estimated))]
  logcounts.real = logcounts.real[, order(colnames(logcounts.real))]
  stat = lapply(rownames(logcounts.real), function(gene){
    out = data.frame(gene = gene , corr = cor(logcounts.real[gene,] , logcounts.estimated[gene,] , method = "pearson"))
  })
  stat = do.call(rbind, stat)
  stat$n.genes = mapping$n.genes[1]
  return(stat)
}


getCorrTranscriptome = function(mapping , genes){
  if (class(mapping) == "list"){
    stat.per_nGenes = lapply(mapping, function(current.mapping){
      return(getCorrTranscriptome_oneMapping(current.mapping , genes))
    })
    stat.per_nGenes = do.call(rbind , stat.per_nGenes)
    return(stat.per_nGenes)
  }
  else {
    return(getCorrTranscriptome_oneMapping(mapping , genes))
  }
}

names.mappings = names(mappings)
stats = lapply(1:length(mappings) , function(i){
  stat = getCorrTranscriptome(mappings[[i]] , markers.t)
  saveRDS(stat , file = paste0(root.dir, "data/corr_stat/" , system, "/" , names.mappings[i], ".Rds"))
})


```




#Session Info

```{r sessinf}
sessionInfo()
```
