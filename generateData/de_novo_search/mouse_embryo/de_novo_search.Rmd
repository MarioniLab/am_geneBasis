---
title: "Gene-selection-and-validation"
author: "Alsu Missarova"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gene-selection-and-validation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Load libraries

```{r setup}

library(knitr)
library(SingleCellExperiment)
library(dplyr)
library(ggplot2)
library(scran)
library(batchelor)
library(ggpubr)
library(plyr)
library(stringr)
library(BiocNeighbors)
library(irlba)
library(tibble)
library(BiocParallel)
library(BiocNeighbors)
ncores = 7
mcparam = MulticoreParam(workers = ncores)
register(mcparam)

root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/functions/de_novo_search.R"))

```

# Load data

```{r load-data}


sce = readRDS( paste0( root.dir , "data/scRNA_datasets/atlas_E8.5/sce_atlas_E8.5.Rds"))
rowdata = as.data.frame(rowData(sce))
batch = "sample"


```

# Select HVGs and de-noise

```{r get-hvgs-and-denoise}


if (!(file.exists( paste0(root.dir , "data/scRNA_datasets/atlas_E8.5/sce_atlas_E8.5__denoised.Rds")))){
  sce = retain_only_hvgs(sce , var.thresh = 0)
  # denoise logcounts
  logcounts_denoised = denoise_logcounts(sce, batch = batch, n.neigh = 10, nPC = 100)
  sce_denoised = SingleCellExperiment(list(counts=counts(sce) , 
                                  logcounts = logcounts_denoised) , 
                             colData = colData(sce) , rowData = rowData(sce))
  rownames(sce_denoised) = rowData(sce_denoised)[,2]
  tab = table(rownames(sce_denoised))
  genes.unq = names(tab)[tab == 1]
  sce_denoised = sce_denoised[genes.unq , ]
  saveRDS(sce_denoised , file = paste0(root.dir , "data/scRNA_datasets/atlas_E8.5/sce_atlas_E8.5__denoised.Rds"))
} else {
  sce = retain_only_hvgs(sce , var.thresh = 0)
  sce_denoised = readRDS( paste0(root.dir , "data/scRNA_datasets/atlas_E8.5/sce_atlas_E8.5__denoised.Rds") )
}


```

# Get correlation-all and loadings squared

```{r get-corr-all}


corr.thresh = 0.75
corr_stat_all = get_corr_transcriptome_per_gene(sce_denoised , assay = "logcounts", genes = rownames(sce_denoised), batch = batch ,
                                           n.neigh = 5 , nPC = 100 , genes.predict = rownames(sce_denoised) , method = "spearman")
corr_stat_all = corr_stat_all[!is.na(corr_stat_all$corr) , ]
colnames(corr_stat_all) = c("gene" , "corr.all")
corr_stat_all = corr_stat_all[corr_stat_all$corr.all > corr.thresh , ]

# add squared loadings
loadings.squared = get_loadings_squared(sce_denoised)
corr_stat_all = merge(corr_stat_all , loadings.squared , all.x = T , all.y = F)

saveRDS(corr_stat_all , file = paste0(root.dir , "data/scRNA_datasets/atlas_E8.5/corr_stat_all.Rds"))


```

# Get genes basis

## Using minimum correlation

```{r get-genes-basis-min-corr}


min.corr.thresh = 0.95
genes_keep = as.character( corr_stat_all$gene )
corr_stat_all = corr_stat_all[order(corr_stat_all$corr.all , decreasing = T) , ]
genes_base = as.character( corr_stat_all$gene[1:3] )
genes_all = as.character( genes_base )
genes = list()
corr_stat = list()
eps = 0.00001
min.corr = 0


while(min.corr < min.corr.thresh ){
  corr_stat_genes = suppressWarnings( get_corr_transcriptome_per_gene(sce_denoised , assay = "logcounts" , genes = genes_all , batch = batch, n.neigh = 5 , nPC = length(genes_all) - 1 , genes.predict = genes_keep , method = "spearman"))
  corr_stat_genes = corr_stat_genes[!corr_stat_genes$gene %in% genes_all , ]
  
  corr_stat_genes$corr[is.na(corr_stat_genes$corr)] = eps
  corr_stat_genes$corr[corr_stat_genes$corr <= 0] = eps
  
  corr_stat_genes = merge(corr_stat_genes , corr_stat_all , all.x = T , all.y = F)
  corr_stat_genes$corr.ratio = corr_stat_genes$corr/corr_stat_genes$corr.all
  
  min.corr = min(corr_stat_genes$corr.ratio)
  idx = which(corr_stat_genes$corr.ratio == min.corr)
  gene = corr_stat_genes$gene[idx[1]]
  genes_all = c(genes_all , gene)
  genes[[length(genes) + 1 ]] = genes_all
  corr_stat_genes$n_genes = length(genes_all)
  corr_stat[[length(corr_stat) + 1]] = min.corr
}

min_corr_stat = data.frame(n_genes = c(4:length(genes_all)) , min_corr = unlist(corr_stat) , gene = genes_all[4:length(genes_all)])
min_corr_stat = rbind(data.frame(n_genes = 1:3 , min_corr = c(0,0,0) , gene = genes_all[1:3]) , min_corr_stat)
out = list(genes = genes_all , min_corr_stat = min_corr_stat)
saveRDS(out , file = paste0(root.dir , "data/gene_basis/mouse_embryo/mouse_embryo__minCorr_selection.Rds"))



```

##  Using highest loading approach

```{r get-genes-basis-highest-loading}


min.corr.thresh = 0.95
genes_keep = as.character( corr_stat_all$gene )
corr_stat_all = corr_stat_all[order(corr_stat_all$loading.squared , decreasing = T) , ]
genes_base = as.character( corr_stat_all$gene[1:3] )
genes_all = as.character( genes_base )
genes = list()
corr_stat = list()
eps = 0.00001
min.corr = 0


while(min.corr < min.corr.thresh ){
  corr_stat_genes = suppressWarnings( get_corr_transcriptome_per_gene(sce_denoised , assay = "logcounts" , genes = genes_all , batch = NULL, n.neigh = 5 , nPC = length(genes_all) - 1 , genes.predict = genes_keep , method = "spearman"))
  corr_stat_genes = corr_stat_genes[!corr_stat_genes$gene %in% genes_all , ]
  
  corr_stat_genes$corr[is.na(corr_stat_genes$corr)] = eps
  corr_stat_genes$corr[corr_stat_genes$corr <= 0] = eps
  
  corr_stat_genes = merge(corr_stat_genes , corr_stat_all , all.x = T , all.y = F)
  corr_stat_genes$corr.ratio = corr_stat_genes$corr/corr_stat_genes$corr.all
  
  # select genes
  corr_stat_genes = corr_stat_genes[corr_stat_genes$corr.ratio < min.corr.thresh , ]
  if (nrow(corr_stat_genes) > 0){
    
    min.corr = min(corr_stat_genes$corr.ratio)
    idx = which(corr_stat_genes$loading.squared == max(corr_stat_genes$loading.squared))
    gene = corr_stat_genes$gene[idx[1]]
    
    # update the output
    genes_all = c(genes_all , gene)
    genes[[length(genes) + 1 ]] = genes_all
    corr_stat_genes$n_genes = length(genes_all)
    corr_stat[[length(corr_stat) + 1]] = min.corr
  }
  else {
    break
  }
}



min_corr_stat = data.frame(n_genes = c(4:length(genes_all)) , min_corr = unlist(corr_stat) , gene = genes_all[4:length(genes_all)])
min_corr_stat = rbind(data.frame(n_genes = 1:3 , min_corr = c(0,0,0) , gene = genes_all[1:3]) , min_corr_stat)
out = list(genes = genes_all , min_corr_stat = min_corr_stat)
saveRDS(out , file = paste0(root.dir , "data/gene_basis/mouse_embryo/mouse_embryo__maxLoading_selection.Rds"))




```



