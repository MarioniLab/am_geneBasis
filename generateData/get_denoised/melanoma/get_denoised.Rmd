---
title: "Gene selection."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

#Introduction & method


```{r load, message = FALSE}
# load libraries we are going to use


library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
ncores = 4
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)

#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir , "am_geneBasis/functions/main_functions.R"))


system = "melanoma"
sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))
meta = as.data.frame(colData(sce))



```

# Add denoised and cosine normalized logcounts

```{r denoise , message = FALSE}


sce = retain_only_hvgs(sce , n = 10000 , var.thresh = 0)
logcounts.denoised = denoise_logcounts(sce, batch = "sample", n.neigh = 10, nPC = 50, ncores = ncores)

# combine together
sce_denoised = SingleCellExperiment(assays = list("logcounts" = logcounts(sce), 
                                                  "logcounts.denoised" = logcounts.denoised), colData = colData(sce))  
reducedDims(sce_denoised) = reducedDims(sce)  

  
```


# Add z-score normalisation

```{r add-z-score, message = FALSE}

# 
# add_z_norm = function(sce , assay , batch = "sample"){
#   counts = assay(sce , assay)
#   if (is.null(batch)){
#     counts_normed = t(apply(counts, 1 , function(x) scale(x)))
#     idx = which(is.na(counts_normed))
#     counts_normed[idx] = 0
#     colnames(counts_normed) = colnames(counts)
#   }
#   else {
#     meta = as.data.frame(colData(sce))
#     batchFactor = factor(meta[, colnames(meta) == batch])
#     counts_normed = lapply(unique(batchFactor) , function(current.batch){
#       idx = which(batchFactor == current.batch)
#       current.counts = counts[, idx]
#       current.counts_normed = t(apply(current.counts, 1 , function(x) scale(x)))
#       idx = which(is.na(current.counts_normed))
#       current.counts_normed[idx] = 0
#       colnames(current.counts_normed) = colnames(current.counts)
#       
#       return(current.counts_normed)
#     })
#     counts_normed = do.call(cbind , counts_normed)
#     counts_normed = counts_normed[, match(colnames(sce) , colnames(counts_normed))]
#   }
#   return(counts_normed)
# }
#   
# normed.logcounts = add_z_norm(sce_denoised , "logcounts" , batch = "sample")
# assay(sce_denoised , "normed.logcounts") = normed.logcounts
# normed.logcounts.denoised = add_z_norm(sce_denoised , "logcounts.denoised" , batch = "sample")
# assay(sce_denoised , "normed.logcounts.denoised") = normed.logcounts.denoised

# save
saveRDS(sce_denoised , paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_denoised_" , system , ".Rds"))


```

#Session Info

```{r sessinf}
sessionInfo()
```
