---
title: "Generate relevant data for kidney."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(batchelor)
library(uwot)
library(tibble)
library(scran)
library(plyr)
library(dplyr)

system = "kidney"
#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
save.dir = paste0(root.dir , "data/main_analysis/" , system , "/")
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
source(paste0(root.dir, "am_geneBasis/functions/main_functions.R"))

sce = readRDS(paste0( root.dir, "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))


```

<!-- # Discard highly expressed genes -->

<!-- ```{r discard-highly-expressed-genes, message = FALSE} -->


<!-- sce = get_rid_of_highly_expressed_genes(sce) -->


<!-- ``` -->

# Discard rare celltypes

```{r discard-rare-celltypes, message = FALSE}


rare_celltypes = detect_rare_celltypes(sce)
saveRDS(rare_celltypes , file = paste0(save.dir, "rare_celltypes_stat.Rds"))

sce = get_rid_of_rare_celltypes(sce)


```


# Discard highly and unspecifically (per celltype) expressed genes

```{r discard-highly-expressed-genes, message = FALSE}


stat = lapply(unique(sce$celltype) , function(celltype){
  print(celltype)
  logcounts = as.matrix( logcounts(sce[, sce$celltype == celltype]) )
  current.stat = apply(logcounts , 1 , function(x) quantile(x , .75))
  current.stat = data.frame(gene = names(current.stat) , q75 = current.stat , celltype = celltype)
})
stat = do.call(rbind , stat)
stat = as.data.frame( stat %>% group_by(gene) %>%
                                         dplyr::summarise(max_q75 = max(q75) , 
                                                          frac_q75_positive = mean(q75 > 0)))


# keep only lowly expressed and specific cts
thresh.n_ct = 0.5
thresh.max_q75 = 20
genes = stat$gene[stat$max_q75 < thresh.max_q75 & stat$frac_q75_positive < thresh.n_ct]
sce = sce[genes , ]
meta = as.data.frame(colData(sce))



```



# Initial gene selection

```{r initial-gene-selection, message = FALSE}


genes_de.stat = getMarkers( sce , test = "binom")
saveRDS(genes_de.stat , file = paste0(save.dir, "genes_de_stat.Rds"))
genes_de = as.character( unique( genes_de.stat$gene ) )


```


# Loadings

```{r get-loadings, message = FALSE}


loadings_celltype.stat = get_loadings(sce , genes_de , "celltype")
saveRDS(loadings_celltype.stat , file = paste0(save.dir, "loadings_celltype_stat.Rds"))
  
loadings_none.stat = get_loadings(sce , genes_de , "none")
saveRDS(loadings_none.stat , file = paste0(save.dir, "loadings_none_stat.Rds"))


```

# UMAP

```{r umaps, message = FALSE}


sce.genes_de = sce[rownames(sce) %in% genes_de , ]
counts.genes_de = as.matrix(logcounts(sce.genes_de))
batchFactor = factor( c( as.character(sce.genes_de$sample) ))
pcs.genes_de = multiBatchPCA(counts.genes_de, batch = batchFactor, d = 50)
out = do.call(reducedMNN, pcs.genes_de)
pcs_corrected.genes_de = out$corrected
saveRDS(pcs_corrected.genes_de , file = paste0(save.dir, "pcs_corrected_genes_de.Rds"))

umap.coordinates = as.data.frame(umap(pcs_corrected.genes_de, min_dist = 0.7))
rownames(umap.coordinates) = rownames(pcs_corrected.genes_de)
umap.coordinates = rownames_to_column(umap.coordinates , var = "cell")
colnames(umap.coordinates) = c("cell" , "UMAP_1" , "UMAP_2")
meta = merge(meta , umap.coordinates , by = "cell")
saveRDS(meta , file = paste0(save.dir, "meta_w_umaps_genes_de.Rds"))



```

# BULK

<!-- ## Mapping -->

<!-- ```{r mapping-de-genes, message = FALSE} -->


<!-- mapping.genes_de = get_mapping(genes_de , sce) -->
<!-- saveRDS(mapping.genes_de , file = paste0(save.dir, "mapping_genes_de.Rds")) -->


<!-- ``` -->

<!-- ## Graph structure -->

<!-- ```{r graph-genes-de, message = FALSE} -->


<!-- graph.genes_de = get_graph(genes_de , sce) -->
<!-- saveRDS(graph.genes_de , file = paste0(save.dir, "graph_genes_de.Rds")) -->


<!-- ``` -->


<!-- ## Prediction of transcriptome -->

<!-- ```{r prediction-transcriptome-genes-de, message = FALSE} -->


<!-- corr_transcriptome.genes_de = getCorrTranscriptome(mapping.genes_de , genes_de) -->
<!-- saveRDS(corr_transcriptome.genes_de , file = paste0(save.dir, "corr_transcriptome_genes_de.Rds")) -->


<!-- ``` -->

# Session Info

```{r sessinf}
sessionInfo()
```
