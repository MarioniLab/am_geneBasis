---
title: "Mapping to the atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Loading dependancies


```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
set.seed(32)


#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
sce = readRDS(paste0( root.dir, "data/scRNA_datasets/spleen/sce_spleen.Rds"))
rownames(sce) = rowData(sce)[,1]

reference.bool = sapply(1:ncol(sce), function(i){
  if (sce$sample[i] == 4){
    return(T)
  } else {
    return(F)
  }
})
sce$reference = reference.bool

# delete v rare CTs
tab = table(sce$celltype[sce$reference])
CTs.2keep = names(tab)[tab >= 5]
sce = sce[, sce$celltype %in% CTs.2keep] 
meta = as.data.frame(colData(sce))

# get suitable for seq genes
genes.4seq = get_suitable4seq_genes(dir = "cluster", system = "spleen" , mean.thresh = 7, max.thresh = 350)


# function
get_mapping = function(genes , sce){
  current.sce = sce[rownames(sce) %in% genes , ]
  batchFactor = factor(current.sce$sample)
  current.counts = as.matrix ( cosineNorm( logcounts(current.sce)))
  
  mbpca = multiBatchPCA(current.counts, batch = batchFactor, d = 50)
  out = do.call(reducedMNN, mbpca)
  joint.pca = out$corrected
  
  reference.cells = colnames(current.sce[,current.sce$reference == T])
  query.cells = colnames(current.sce[, current.sce$reference == F])
  current.knns = queryKNN( joint.pca[reference.cells ,], joint.pca[query.cells ,], k = 10,
                           get.index = TRUE, get.distance = FALSE)
  cells.mapped = t( apply(current.knns$index, 1, function(x) reference.cells[x]) )
  cells.mapped = as.data.frame( cells.mapped) 
  for (i in 1:ncol(cells.mapped)){
    cells.mapped[, i] = as.character(cells.mapped[, i])
  }
  
  celltypes = t(apply(cells.mapped, 1, function(x) meta$celltype[match(x, meta$cell)]))
  celltype.mapped = apply(celltypes, 1, function(x) getmode(x, 1:length(x)))
  mapping = data.frame(cell = query.cells , celltype.mapped = celltype.mapped , n.genes = length(genes))
  mapping$celltype.mapped = as.character(mapping$celltype.mapped)
  mapping = cbind(mapping , cells.mapped )
  return(mapping)
}


```

# Mapping

## Binom

```{r mapping-binom , message = FALSE}

# load markers
markers = read.table(paste0(root.dir , "data/markers/spleen/markers__binom.tab") , header = T, sep = "\t")
markers = unique(markers$gene)
markers = intersect(markers , genes.4seq)

mapping = get_mapping(markers , sce)
saveRDS(mapping , file = paste0(root.dir, "data/mappings/spleen/binom_all.Rds"))


```

## T

```{r mapping-t , message = FALSE}

# load markers
markers = read.table(paste0(root.dir , "data/markers/spleen/markers__t.tab") , header = T, sep = "\t")
markers = unique(markers$gene)
markers = intersect(markers , genes.4seq)

mapping = get_mapping(markers , sce)
saveRDS(mapping , file = paste0(root.dir, "data/mappings/spleen/t_all.Rds"))


```

#Session Info

```{r sessinf}
sessionInfo()
```
