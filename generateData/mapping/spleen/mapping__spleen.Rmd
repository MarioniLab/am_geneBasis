---
title: "Mapping to the atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
#Introduction & method

In this script we map cells from the FAS-affected embryos (+ 4 samples from the atlas experiment) onto our atlas.

```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
set.seed(32)


#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
sce = readRDS(paste0( root.dir, "data/spleen/sce_spleen.Rds"))

reference.bool = sapply(1:ncol(sce), function(i){
  if (sce$sample[i] == 4){
    return(T)
  } else {
    return(F)
  }
})
sce$reference = reference.bool

tab = table(sce$celltype[sce$reference])
CTs.2keep = names(tab)[tab > 10]
sce = sce[, sce$celltype %in% CTs.2keep] 

meta = as.data.frame(colData(sce))


# read gene selection
genes_unweighted_scaled__oneRound = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_unweighted_scaled__oneRound" , ".tab"), header = T , sep = "\t")

genes_weighted_scaled__oneRound = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_weighted_scaled__oneRound" , ".tab"), header = T , sep = "\t")

genes_unweighted_unscaled__oneRound = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_unweighted_unscaled__oneRound" , ".tab"), header = T , sep = "\t")

genes_weighted_unscaled__oneRound = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_weighted_unscaled__oneRound" , ".tab"), header = T , sep = "\t")



genes_unweighted_scaled__twoRounds = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_unweighted_scaled__twoRounds" , ".tab"), header = T , sep = "\t")

genes_weighted_scaled__twoRounds = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_weighted_scaled__twoRounds" , ".tab"), header = T , sep = "\t")

genes_unweighted_unscaled__twoRounds = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_unweighted_unscaled__twoRounds" , ".tab"), header = T , sep = "\t")

genes_weighted_unscaled__twoRounds = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_weighted_unscaled__twoRounds" , ".tab"), header = T , sep = "\t")



genes_unweighted_scaled__totalScore = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_unweighted_scaled__twoRounds" , ".tab"), header = T , sep = "\t")

genes_weighted_scaled__totalScore = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_weighted_scaled__twoRounds" , ".tab"), header = T , sep = "\t")

genes_unweighted_unscaled__totalScore = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_unweighted_unscaled__twoRounds" , ".tab"), header = T , sep = "\t")

genes_weighted_unscaled__totalScore = read.table(paste0(root.dir , "data/gene_selection/spleen/" , "genes_weighted_unscaled__twoRounds" , ".tab"), header = T , sep = "\t")


unq.markers = read.table(paste0(root.dir , "data/markers/" , "markers__spleen" , ".tab"), header = T , sep = "\t")
unq.markers = unique(unq.markers$gene)

```

# Big mapping

```{r mappings-big , message = FALSE}



# mapping all
current.sce = sce[rownames(sce) %in% unq.markers , ]
batchFactor = factor(current.sce$sample)
current.counts = as.matrix ( cosineNorm( logcounts(current.sce)))

mbpca = multiBatchPCA(current.counts, batch = batchFactor, d = 50)
out = do.call(reducedMNN, mbpca)
joint.pca = out$corrected
  
reference.cells = colnames(current.sce[,current.sce$reference == T]) 
query.cells = colnames(current.sce[, current.sce$reference == F]) 
current.knns = queryKNN( joint.pca[reference.cells ,], joint.pca[query.cells ,], k = 10, 
                           get.index = TRUE, get.distance = FALSE)
cells.mapped = t( apply(current.knns$index, 1, function(x) reference.cells[x]) )
celltypes = t(apply(cells.mapped, 1, function(x) meta.atlas$celltype[match(x, meta.atlas$cell)]))
celltype.mapped = apply(celltypes, 1, function(x) getmode(x, 1:length(x)))
mapping.all = data.frame(cell = query.cells , celltype.mapped = celltype.mapped , n.genes = length(unq.markers))
mapping.all$celltype.mapped = as.character(mapping.all$celltype.mapped)
mapping.all = cbind(mapping.all , as.data.frame( cells.mapped) ) 
saveRDS(mapping.all , file = paste0(root.dir, "data/mappings/spleen/all_markers.Rds"))
  




```

# Mapping - selected features

```{r mappings-all , message = FALSE}


getMapping = function(genes, n.neigh = 10){
  current.sce = sce[rownames(sce) %in% genes , ]
  # preselect cells with 0 counts in all the genes
  current.counts = as.matrix ( cosineNorm( logcounts(sce)))
  colsums.current.counts = colSums(current.counts)
  cells.0genes = names(colsums.current.counts)[colsums.current.counts == 0]
  
  # do mapping
  batchFactor = factor(current.sce$sample)
  
  mbpca = multiBatchPCA(current.counts, batch = batchFactor, d = 50)
  out = do.call(reducedMNN, mbpca)
  joint.pca = out$corrected
  
  reference.cells = colnames(current.sce[,current.sce$reference == T]) 
  query.cells = colnames(current.sce[, current.sce$reference == F]) 
  current.knns = queryKNN( corrected.atlas[reference.cells ,], corrected.atlas[query.cells ,], k = n.neigh, 
                           get.index = TRUE, get.distance = FALSE)
  cells.mapped = t( apply(current.knns$index, 1, function(x) reference.cells[x]) )
  celltypes = t(apply(cells.mapped, 1, function(x) meta.atlas$celltype[match(x, meta.atlas$cell)]))
  celltype.mapped = apply(celltypes, 1, function(x) getmode(x, 1:length(x)))
  out = data.frame(cell = query.cells , celltype.mapped = celltype.mapped , n.genes = length(genes))
  
  out$celltype.mapped = as.character(out$celltype.mapped)
  idx = which(out$cell %in% cells.0genes)
  out$celltype.mapped[idx] = "Unmapped" 
  
  out = cbind(out , as.data.frame( cells.mapped) )
  return(out)
}

# get my mappings
nPC.grid = seq(10,100,5) 


mappings = lapply(nPC.grid , function(i){
  current.genes = genes_weighted_scaled__oneRound$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/weighted_scaled__oneRound.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_weighted_unscaled__oneRound$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/weighted_unscaled__oneRound.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_unweighted_scaled__oneRound$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/unweighted_scaled__oneRound.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_unweighted_unscaled__oneRound$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/unweighted_unscaled__oneRound.Rds"))






mappings = lapply(nPC.grid , function(i){
  current.genes = genes_weighted_scaled__twoRounds$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/weighted_scaled__twoRounds.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_weighted_unscaled__twoRounds$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/weighted_unscaled__twoRounds.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_unweighted_scaled__twoRounds$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/unweighted_scaled__twoRounds.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_unweighted_unscaled__twoRounds$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/unweighted_unscaled__twoRounds.Rds"))








mappings = lapply(nPC.grid , function(i){
  current.genes = genes_weighted_scaled__totalScore$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/weighted_scaled__totalScore.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_weighted_unscaled__totalScore$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/weighted_unscaled__totalScore.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_unweighted_scaled__totalScore$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/unweighted_scaled__totalScore.Rds"))
#
mappings = lapply(nPC.grid , function(i){
  current.genes = genes_unweighted_unscaled__totalScore$gene[1:i]
  return(getMapping(current.genes))
})
names(mappings) = paste0("nGenes_" , nPC.grid)
saveRDS(mappings , file = paste0(root.dir, "data/mappings/spleen/unweighted_unscaled__totalScore.Rds"))







# Bianca's
mappings.bianca.centers = lapply(nPC.grid , function(i){
  current.genes = read.table(paste0(root.dir , "data/gene_selection/spleen/bianca_markers/centers/num_markers__" , i , ".tab"), header = F, sep = "\t")
  current.genes = current.genes$V1
  return(getMapping(current.genes))
})
saveRDS(mappings.bianca.centers , file = paste0(root.dir, "data/mappings/spleen/bianca__centers.Rds"))


mappings.bianca.pairwise = lapply(nPC.grid , function(i){
  current.genes = read.table(paste0(root.dir , "data/gene_selection/spleen/bianca_markers/pairwise/num_markers__" , i , ".tab"), header = F, sep = "\t")
  current.genes = current.genes$V1
  return(getMapping(current.genes))
})
saveRDS(mappings.bianca.pairwise , file = paste0(root.dir, "data/mappings/spleen/bianca__pairwise.Rds"))


mappings.bianca.pairwise_centers = lapply(nPC.grid , function(i){
  current.genes = read.table(paste0(root.dir , "data/gene_selection/spleen/bianca_markers/pairwise_centers/num_markers__" , i , ".tab"), header = F, sep = "\t")
  current.genes = current.genes$V1
  return(getMapping(current.genes))
})
saveRDS(mappings.bianca.pairwise_centers , file = paste0(root.dir, "data/mappings/spleen/bianca__pairwise_centers.Rds"))


# # random forest
# current.genes = read.table(paste0(root.dir , "data/gene_selection/atlas__E8_5/RF_markers" , ".tab"), header = T, sep = "\t")
# current.genes = genes.info$SYMBOL[genes.info$ENSEMBL %in% current.genes$gene]
# mappings.rf = getMapping_all(current.genes)
# saveRDS(mappings.rf , file = paste0(root.dir, "data/mappings/atlas__E8_5/all/RF.Rds"))



```



#Session Info

```{r sessinf}
sessionInfo()
```
