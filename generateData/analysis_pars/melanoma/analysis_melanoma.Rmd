---
title: "Pipeline to assess gene selection for melanoma"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}

library(knitr)
library(SingleCellExperiment)
library(ggplot2)
library(ggpubr)
library(viridis)
library(wesanderson)
library(igraph)
library(batchelor)
library(stats)
library(BiocNeighbors)
library(tibble)
library(reshape2)
library(plyr)
library(dplyr)
library(scran)
library(batchelor)
library(uwot)
library(stringr)
library(BiocSingular)
library(BiocParallel)
ncores = 4
mcparam = MulticoreParam(workers = ncores)
register(mcparam)

#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/functions/main_functions.R"))
source(paste0(root.dir, "am_geneBasis/visualization_functions.R"))

system = "melanoma"
figures.dir = paste0(root.dir , "figures/main/" , system, "/")

# read sce 
sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_denoised_" , system , ".Rds"))

# read gene selection
gene_selections.files = list.files(path=paste0(root.dir , "data/gene_selection/" , system , "/"))
gene_selections = lapply(gene_selections.files , function(current.file){
  out = readRDS(paste0(root.dir , "data/gene_selection/" , system , "/" , current.file))
  return(out)
})
gene_selections.anno = lapply(1:length(gene_selections.files) , function(i){
  current.file = gene_selections.files[i]
  current.str = str_remove(current.file , ".Rds")
  current.str = str_split(current.str , "_")
  out = data.frame(id = i, assay = current.str[[1]][1] , type = current.str[[1]][2] , ratio.type = current.str[[1]][3] , run = current.str[[1]][4])
  return(out)
})
gene_selections.anno = do.call(rbind , gene_selections.anno)
gene_selections.anno$descr = paste0(gene_selections.anno$assay , "_" , gene_selections.anno$type , "_" , gene_selections.anno$ratio.type )
  
  

# get meta w/umaps
meta = as.data.frame(colData(sce))
if (!( "cell" %in% colnames(meta) )){
  meta = rownames_to_column(meta , var = "cell")
}
if (system == "atlas_E8.5"){
  umaps = as.data.frame( reducedDim(sce , "umap") )
  if (!( "cell" %in% colnames(umaps) )){
    umaps = rownames_to_column(umaps , var = "cell")
  }
} else {
  umaps = as.data.frame( reducedDim(sce , "UMAP"))
  colnames(umaps)[which(colnames(umaps) == "x")] = "V1"
  colnames(umaps)[which(colnames(umaps) == "y")] = "V2"
  if (!( "cell" %in% colnames(umaps) )){
    umaps = rownames_to_column(umaps , var = "cell")
  }
}
meta = merge(meta, umaps)
meta$sample = factor(meta$sample)
meta$celltype = factor(meta$celltype)

n_genes.grid = seq(25,150,25)


```

# Set up color schemes

```{r color-schemes, message = FALSE}


run_cols = c("aquamarine4" , "chocolate" , "deeppink3")

celltype_cols = celltype_colors[[which( names(celltype_colors) == system )]]


```

# UMAP - colored by sample and celltype


```{r umaps-overall, message = FALSE}


p1 = ggplot(meta , aes(x = V1 , y = V2 , col = sample)) + 
  geom_point(size=.75) +
  theme_classic()
p2 = ggplot(meta , aes(x = V1 , y = V2 , col = celltype)) + 
  geom_point(size=.75) +
  scale_color_manual(values = celltype_cols)
  theme_classic()
p = ggarrange(p1,p2,ncol=2)
p
ggsave(filename = paste0(figures.dir, "umaps_overall" ,".png"), plot = p, width = 10, height = 6)


```

# Which genes do I select

## UMAPs

```{r plot-umaps, message = FALSE}


get_umaps = function(genes){
  plots = lapply(genes , function(gene){
    counts = data.frame(cell = colnames(sce) , counts = as.numeric(assay(sce_denoised , "logcounts.denoised")[gene , ]))
    current.meta = merge(meta , counts)
    current.meta = current.meta[order(current.meta$counts) , ]
    p <- ggplot(current.meta , aes(x = V1 , y = V2 , col = counts)) +
      geom_point(size=.5) +
      scale_color_gradient(low = "azure3" , high = "darkgreen") + 
      theme_classic() +
      theme(legend.position="none") +
      ggtitle(gene)
    return(p)
  })
  p <- ggarrange(plotlist = plots , ncol = length(genes))
  return(p)
}

plots = lapply(1:nrow(gene_selections.anno) , function(i){
  plots.per_selection = lapply(n_genes.grid , function(n_genes){
    current.genes = gene_selections[[i]][n_genes-24:n_genes]
    p = get_umaps(current.genes)
    if (!dir.exists(paste0(figures.dir , "umaps/" , gene_selections.anno$descr[i] , "_" , gene_selections.anno$run[i]))){
      dir.create( paste0(figures.dir , "umaps/" , gene_selections.anno$descr[i] , "_" , gene_selections.anno$run[i]) )
    }
    ggsave(filename = paste0(figures.dir , "umaps/" , gene_selections.anno$descr[i] , "_" , gene_selections.anno$run[i] , "/", n_genes , ".png"), plot = p, width = 20, height = 7)
    return(NA)
  })
  return(NA)
})



```


## Get overall stat on genes: corr, dist (L1 and L2), mean and frac expressed

Calculated on logcounts-denoised (~ matters for correlation)

```{r get-general-stat, message = FALSE}


nPC = 50
assay = "logcounts.denoised"

dist.l2_stat_all = suppressWarnings( get_distr_dist(sce, genes = rownames(sce), assay = assay , batch = "sample" , n.neigh = 5 , nPC = 50 , genes.predict = rownames(sce) , type = "dist.l2") )

dist.l1_stat_all = suppressWarnings( get_distr_dist(sce, genes = rownames(sce), assay = assay , batch = "sample" , n.neigh = 5 , nPC = 50 , genes.predict = rownames(sce) , type = "dist.l1") )

corr_stat_all = suppressWarnings( get_distr_dist(sce, genes = rownames(sce), assay = assay , batch = "sample" , n.neigh = 5 , nPC = 50 , genes.predict = rownames(sce) , type = "corr") )

mean_stat = apply(assay(sce , assay) , 1 , mean)
mean_stat = data.frame(gene = names(mean_stat) , mean.logcounts = mean_stat)

frac.expressed_stat = apply(assay(sce , assay) , 1 , function(x) mean(x > 0))
frac.expressed_stat = data.frame(gene = names(frac.expressed_stat) , frac.expressed = frac.expressed_stat)


# merge
stat_all = merge(mean_stat , frac.expressed_stat)
stat_all = merge(stat_all , dist.l2_stat_all)
stat_all = merge(stat_all , dist.l1_stat_all)
stat_all = merge(stat_all , corr_stat_all)
saveRDS(stat_all , file = paste0(root.dir , "data/main_analysis/" , system , "/general_stat.Rds"))


```

## How do the parameters distribute for selections

```{r plot-general-stat, message = FALSE}

  
stat_selections = bplapply(1:nrow(gene_selections.anno) , function(i){
  current.stat = stat_all[stat_all$gene %in% gene_selections[[i]][1:100] , ]
  current.stat$id = i
  current.stat = merge(current.stat , gene_selections.anno , all.x = T , all.y = F)
  return(current.stat)  
}, BPPARAM = mcparam)
stat_selections = do.call(rbind , stat_selections)


get_general_stat_plot = function(var){
  p = ggplot(stat_selections , aes(x = descr , y = stat_selections[, var] , fill = run)) + 
    geom_boxplot() +
    scale_fill_manual(values = run_cols) +
    ggtitle(var) + 
    labs(y = var) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
  return(p)
}


vars = setdiff( colnames(stat_all) , "gene" )
plots = lapply(vars , function(var){
  p = get_general_stat_plot(var)
  print(p)
  ggsave(filename = paste0(figures.dir, "general_stat/" , var ,".png"), plot = p, width = 8, height = 6)
  return(p)
})



```

# Do my selections contain strong markers

```{r get-marker-stat, message = FALSE}


markers = get_markers(sce , test = "t")
stat_selections = merge(stat_selections , markers, all.x = T , all.y = F)
stat_selections$celltype[is.na(stat_selections$celltype)] = "not_marker"
saveRDS(stat_selections , file = paste0(root.dir , "data/main_analysis/" , system , "/general_stat_selections.Rds"))


marker_stat_selections = as.data.frame( stat_selections %>% group_by(assay , type , ratio.type , run , descr , celltype) %>%
  dplyr::summarise(n = n()) )
marker_stat_selections = marker_stat_selections[!marker_stat_selections$celltype == "not_marker" , ]


p = ggplot(marker_stat_selections , aes(x = descr, y = n , fill = celltype)) + 
  geom_bar(stat = "identity" , position = "stack") + 
  scale_fill_manual(values = celltype_cols) +
  facet_wrap(~run) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
p
ggsave(filename = paste0(figures.dir, "marker_distr.png"), plot = p, width = 12, height = 6)



```

# Quantitative assessment of selections overall

## Get celltype mapping

```{r get-celltype-mapping, message = FALSE}


get_celltypes_stat = function(sce , genes , batch = "sample", n.neigh = 5 , nPC = NULL, type = "together"){
  neighs = suppressWarnings( get_mapping(sce , assay = "logcounts" , genes = genes, batch = batch, n.neigh = n.neigh, nPC = nPC , get.dist = F , type = type))
  if (!is.null(neighs)){
    meta = as.data.frame(colData(sce))
    current.mapping = data.frame(cell = rownames(neighs) , 
                               celltype = sapply(1:nrow(neighs) , function(i) meta$celltype[meta$cell == rownames(neighs)[i]]) , 
                               mapped_celltype = sapply(1:nrow(neighs), function(i) getmode(meta$celltype[match(neighs[i,] , meta$cell)] , 1:n.neigh) ))
    current.stat = get_fraction_mapped_correctly(current.mapping)
    return(current.stat)
  } 
  else {
    return(NULL)
  }
}

stat_mapping_celltypes = bplapply(1:nrow(gene_selections.anno), function(i){
  stat.per_selection = lapply(n_genes.grid , function(n_genes){
    current.stat = get_celltypes_stat( sce , genes = gene_selections[[i]][1:n_genes] , batch = "sample", nPC = 50 )
    if (!is.null(current.stat)){
      current.stat$n_genes = n_genes
      current.stat$id = i
      current.stat = merge(current.stat , gene_selections.anno , all.x = T , all.y = F)
      return(current.stat)
    }
    else {
      return(NULL)
    }
  })
  stat.per_selection = do.call(rbind , stat.per_selection)
  return(stat.per_selection)
}, BPPARAM = mcparam)
stat_mapping_celltypes = do.call(rbind , stat_mapping_celltypes)
saveRDS(stat_mapping_celltypes , file = paste0(root.dir , "data/main_analysis/" , system , "/stat_celltypes.Rds"))


# overall plot
p = ggplot(stat_mapping_celltypes , aes(x = factor(n_genes) , y = frac_correctly_mapped , fill = descr)) + 
  geom_boxplot() + 
  facet_wrap(~run, nrow = 3) + 
  theme_classic()
p
ggsave(filename = paste0(figures.dir, "celltype_mapping_overall.png"), plot = p, width = 20, height = 6)





```

## Per celltype: mapping saturation plots

```{r plot-celltype-mapping-saturation, message = FALSE}


get_ct_saturation_plot = function(celltype){
  idx = which(stat_mapping_celltypes$celltype == celltype)
  p <- ggplot(stat_mapping_celltypes[idx , ] , aes(x = n_genes , y = frac_correctly_mapped , col = run)) + 
    geom_line() + 
    facet_wrap(~descr) + 
    ggtitle(celltype) + 
    theme_classic()
  return(p)
}


unq.celltypes = unique(sce$celltype)
plots = lapply(unq.celltypes , function(celltype){
  p = get_ct_saturation_plot(celltype)
  if (!dir.exists(paste0(figures.dir , "per_celltype/"))){
    dir.create(paste0(figures.dir , "per_celltype/"))
  }
  ggsave(filename = paste0(figures.dir, "per_celltype/", celltype , ".png"), plot = p, width = 10, height = 6)
  return(NA)
})



```

## Cell score

```{r get-cell-score, message = FALSE}



neighs.all = get_mapping(sce , assay = "logcounts", genes = rownames(sce), batch = "sample", n.neigh = "all", nPC = 50 , get.dist = T , type = "together")

stat_cell_score.nPC_50 = bplapply(1:nrow(gene_selections.anno), function(i){
  stat.per_selection = lapply(n_genes.grid , function(n_genes){
    print(n_genes)
    current.stat = suppressWarnings( get_preservation_score_simple(sce , neighs.all = neighs.all , assay = "logcounts" , genes.all = rownames(sce) , 
                                  genes.compare = gene_selections[[i]][1:n_genes], batch = "sample", n.neigh = 5 , nPC.all = 50 , nPC.compare = 50 ) )
   if (!is.null(current.stat)){
      current.stat$n_genes = n_genes
      current.stat$id = i
      current.stat$nPC = 50
      current.stat = merge(current.stat , gene_selections.anno , all.x = T , all.y = F)
      return(current.stat)
    }
    else {
      return(NULL)
    }
  })
  stat.per_selection = do.call(rbind , stat.per_selection)
  return(stat.per_selection)
}, BPPARAM = mcparam)
stat_cell_score.nPC_50 = do.call(rbind , stat_cell_score.nPC_50)

# all genes
stat_cell_score.nPC_all = bplapply(1:nrow(gene_selections.anno), function(i){
  stat.per_selection = lapply(n_genes.grid , function(n_genes){
    print(n_genes)
    current.stat = suppressWarnings( get_preservation_score_simple(sce , neighs.all = neighs.all , assay = "logcounts" , genes.all = rownames(sce) , 
                                  genes.compare = gene_selections[[i]][1:n_genes], batch = "sample", n.neigh = 5 , nPC.all = 50 , nPC.compare = NULL ) )
   if (!is.null(current.stat)){
      current.stat$n_genes = n_genes
      current.stat$id = i
      current.stat$nPC = "all"
      current.stat = merge(current.stat , gene_selections.anno , all.x = T , all.y = F)
      return(current.stat)
    }
    else {
      return(NULL)
    }
  })
  stat.per_selection = do.call(rbind , stat.per_selection)
  return(stat.per_selection)
}, BPPARAM = mcparam)
stat_cell_score.nPC_all = do.call(rbind , stat_cell_score.nPC_all)

# merge
stat_cell_score = rbind(stat_cell_score.nPC_50 , stat_cell_score.nPC_all)
saveRDS(stat_cell_score , file = paste0(root.dir , "data/main_analysis/" , system , "/stat_cell_score.Rds"))


# plot
p1 = ggplot(stat_cell_score[stat_cell_score$nPC == 50 , ] , aes(x = factor(n_genes) , y = score , fill = descr)) + 
  geom_boxplot() + 
  facet_wrap(~run, nrow = 3) + 
  ggtitle("PCA, 50") +
  theme_classic()
p2 = ggplot(stat_cell_score[stat_cell_score$nPC == "all" , ] , aes(x = factor(n_genes) , y = score , fill = descr)) + 
  geom_boxplot() + 
  facet_wrap(~run, nrow = 3) + 
  ggtitle("no PCA") + 
  theme_classic()
p = ggarrange(p1,p2, common.legend = T)
p
ggsave(filename = paste0(figures.dir, "cell_score.png"), plot = p, width = 15, height = 6)




```


# Gene score

```{r get-gene-score, message = FALSE}


stat_gene_score.nPC_50 = bplapply(1:nrow(gene_selections.anno), function(i){
  stat.per_selection = lapply(n_genes.grid , function(n_genes){
    print(n_genes)
    current.stat = suppressWarnings( get_distr_dist(sce, genes = gene_selections[[i]][1:n_genes], assay = "logcounts.denoised" , batch = "sample" , n.neigh = 5 , nPC = 50 , genes.predict = rownames(sce) , type = "corr") ) 
   if (!is.null(current.stat)){
      current.stat$n_genes = n_genes
      current.stat$id = i
      current.stat$nPC = 50
      current.stat = merge(current.stat , gene_selections.anno , all.x = T , all.y = F)
      return(current.stat)
    }
    else {
      return(NULL)
    }
  })
  stat.per_selection = do.call(rbind , stat.per_selection)
  return(stat.per_selection)
}, BPPARAM = mcparam)
stat_gene_score.nPC_50 = do.call(rbind , stat_gene_score.nPC_50)



stat_gene_score.nPC_all = bplapply(1:nrow(gene_selections.anno), function(i){
  stat.per_selection = lapply(n_genes.grid , function(n_genes){
    current.stat = suppressWarnings( get_distr_dist(sce, genes = gene_selections[[i]][1:n_genes], assay = "logcounts.denoised" , batch = "sample" , n.neigh = 5 , nPC = NULL , genes.predict = rownames(sce) , type = "corr") ) 
   if (!is.null(current.stat)){
      current.stat$n_genes = n_genes
      current.stat$id = i
      current.stat$nPC = "all"
      current.stat = merge(current.stat , gene_selections.anno , all.x = T , all.y = F)
      return(current.stat)
    }
    else {
      return(NULL)
    }
  })
  stat.per_selection = do.call(rbind , stat.per_selection)
  return(stat.per_selection)
}, BPPARAM = mcparam)
stat_gene_score.nPC_all = do.call(rbind , stat_gene_score.nPC_all)


# merge
stat_gene_score = rbind(stat_gene_score.nPC_50 , stat_gene_score.nPC_all)
colnames(stat_all)[which(colnames(stat_all) == "corr")] = "corr.all"
eps = 0.0001
stat_all$corr.all[is.na(stat_all$corr.all)] = eps
stat_all$corr.all[stat_all$corr.all < eps] = eps

stat_gene_score$corr[is.na(stat_gene_score$corr)] = eps
stat_gene_score$corr[stat_gene_score$corr < eps] = eps
stat_gene_score = merge(stat_gene_score , stat_all)
stat_gene_score$corr.rario = stat_gene_score$corr/stat_gene_score$corr.all

saveRDS(stat_gene_score , file = paste0(root.dir , "data/main_analysis/" , system , "/stat_gene_score.Rds"))

# plot
p1 = ggplot(stat_gene_score[stat_gene_score$nPC == 50 , ] , aes(x = factor(n_genes) , y = corr.rario , fill = descr)) + 
  geom_boxplot() + 
  facet_wrap(~run, nrow = 3) + 
  ggtitle("PCA, 50") +
  ylim(c(0.25,1.25)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme_classic() 
p1
p2 = ggplot(stat_gene_score[stat_gene_score$nPC == "all" , ] , aes(x = factor(n_genes) , y = corr.rario , fill = descr)) + 
  geom_boxplot() + 
  facet_wrap(~run, nrow = 3) + 
  ggtitle("no PCA") + 
  ylim(c(0.25,1.25)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme_classic()
p = ggarrange(p1,p2, common.legend = T)
p
ggsave(filename = paste0(figures.dir, "gene_score.png"), plot = p, width = 15, height = 6)




```





# Session Info

```{r sessinf}
sessionInfo()
```
