---
title: "Generate loadings with different criteria for 'celltype specificity' of expression."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

The script is to generate loading stat for spleen using different thresholds for celltype specificity in expression: 

- filter genes that have Q50 > 0 in more than half of celltypes

- filter genes that have Q75 > 0 in more than half of celltypes

# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(batchelor)
library(uwot)
library(tibble)
library(dplyr)
library(scran)


system = "spleen"
#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
save.dir = paste0(root.dir , "data/main_analysis/" , system , "/")
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
source(paste0(root.dir, "am_geneBasis/functions/main_functions.R"))

sce.spleen = readRDS(paste0( root.dir, "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))
sce.spleen = sce.spleen[, sce.spleen$sample %in% c(2,3,4)]


```

# Discard highly expressed genes

```{r discard-highly-expressed-genes, message = FALSE}


#sce = get_rid_of_highly_expressed_genes(sce)

stat.per_ct = lapply(unique(sce$celltype), function(celltype){
  logcounts = logcounts(sce)[, sce$celltype == celltype]
  current.stat = data.frame(q50 = apply(logcounts , 1 , function(x) quantile(x, 0.5)),
                            q75 = apply(logcounts , 1 , function(x) quantile(x, 0.75)),
                            gene = rownames(logcounts))
  return(current.stat)
})
stat.per_ct = do.call(rbind , stat.per_ct)
stat = as.data.frame( stat.per_ct %>% group_by(gene) %>%
                                         dplyr::summarise(n_ct.higher_q50 = mean(q50 > 0) , n_ct.higher_q75 = mean(q75 > 0) )) 

```

# Loadings for genes with median = 0 in majority of celltypes

```{r loadings-median-cut, message = FALSE}


genes.2keep = as.character( stat$gene[stat$n_ct.higher_q50 < 0.5] )
current.sce = sce.spleen[genes.2keep , ]

# detect rare celltypes and discard
rare_celltypes = detect_rare_celltypes(current.sce)
current.sce = get_rid_of_rare_celltypes(current.sce)
current.meta = as.data.frame(colData(current.sce))

# initial gene selection
genes_de.stat = getMarkers( current.sce , test = "binom")
genes_de = as.character( unique( genes_de.stat$gene ) )

# get loadings
loadings_celltype_thresh_q50.stat = get_loadings(current.sce , genes_de , "celltype")
saveRDS(loadings_celltype_thresh_q50.stat , file = paste0(save.dir, "loadings_celltype_thresh_q50_stat.Rds"))
  
loadings_none_thresh_q50.stat = get_loadings(current.sce , genes_de , "none")
saveRDS(loadings_none_thresh_q50.stat , file = paste0(save.dir, "loadings_none_thresh_q50_stat.Rds"))


```

# Loadings for genes with q75 = 0 in majority of celltypes

```{r loadings-q75-cut, message = FALSE}


genes.2keep = as.character( stat$gene[stat$n_ct.higher_q75 < 0.5] )
current.sce = sce.spleen[genes.2keep , ]

# detect rare celltypes and discard
rare_celltypes = detect_rare_celltypes(current.sce)
current.sce = get_rid_of_rare_celltypes(current.sce)
current.meta = as.data.frame(colData(current.sce))

# initial gene selection
genes_de.stat = getMarkers( current.sce , test = "binom")
genes_de = as.character( unique( genes_de.stat$gene ) )

# get loadings
loadings_celltype_thresh_q75.stat = get_loadings(current.sce , genes_de , "celltype")
saveRDS(loadings_celltype_thresh_q50.stat , file = paste0(save.dir, "loadings_celltype_thresh_q75_stat.Rds"))
  
loadings_none_thresh_q75.stat = get_loadings(current.sce , genes_de , "none")
saveRDS(loadings_none_thresh_q50.stat , file = paste0(save.dir, "loadings_none_thresh_q75_stat.Rds"))


```


# Session Info

```{r sessinf}
sessionInfo()
```
