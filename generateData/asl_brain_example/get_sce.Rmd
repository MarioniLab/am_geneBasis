---
title: "Mapping to the atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
#Introduction & method

In this script we map cells from the FAS-affected embryos (+ 4 samples from the atlas experiment) onto our atlas.

```{r load, message = FALSE}
# load libraries we are going to use


library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(scran)
set.seed(32)

root.dir = "/nfs/research1/marioni/alsu/asl_genePanel/"
#root.dir = "/Users/alsu/Develop/asl_genePanel/"


```

# Read counts and meta

```{r read-counts, message = FALSE}
# 
# # read raw counts
# counts = readSparseCounts(paste0(root.dir , "data/matrix.csv") , sep = "," , row.names = T , col.names = T , chunk = 1000L)
# counts = t(counts)
# 
# # read meta, tsne
# meta = read.csv(paste0(root.dir , "data/metadata.csv"))
# tsne = read.csv(paste0(root.dir , "data/tsne.csv"))
# print(mean(tsne$sample_name == meta$sample_name))
# meta = cbind(meta, tsne[, c("tsne_1", "tsne_2")])
# print(mean(meta$sample_name == colnames(counts)))
# # put together
# sce = SingleCellExperiment(list(counts=counts) , colData = meta)
# saveRDS(sce, file = paste0(root.dir, "data/sce.Rds"))
# rm(counts)





```


# Add logcounts

```{r add-logcounts, message = FALSE}


sce = readRDS(paste0(root.dir, "data/sce.Rds"))
sce = lapply(unique(sce$external_donor_name_order) , function(current.batch){
  print(current.batch)
  current.sce = sce[, sce$external_donor_name_order == current.batch]
  clusters = quickCluster(current.sce, method="igraph", use.ranks=TRUE, d=50, min.mean=0.1)
  current.sce = computeSumFactors(current.sce, clusters=clusters)
  return(current.sce)
}) 


sce = do.call(multiBatchNorm , sce )
sce = do.call(cbind, sce)
# select variable genes
dec.sce = modelGeneVar(sce)
hvg.genes = getTopHVGs(dec.sce, var.threshold = 0)
sce = sce[hvg.genes, ]

saveRDS(sce, file = paste0(root.dir, "data/sce.Rds"))




```

#Session Info

```{r sessinf}
sessionInfo()
```
