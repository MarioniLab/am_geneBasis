---
title: "This script is to assemble sce file for Nowotschin data."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

## Load libraries

```{r load, message = FALSE}
# load libraries we are going to use


library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(BiocNeighbors)
library(SingleCellExperiment)
set.seed(32)
root.dir = "/nfs/research1/marioni/alsu/"

```

## Get meta

```{r get-meta}

df = read.csv(paste0( root.dir , "External/Nowotschin_gut/sc_endoderm_all_cells_metadata.csv"), header = TRUE, row.names = 1)

clusterGroups = c(
  "10" = "Thyroid",
  "0" = "Thymus",
  "7" = "Lung 1",
  "8" = "Lung 2",
  "9" = "Liver",
  "3" = "Pancreas 1",
  "4" = "Pancreas 2",
  "2" = "Small intestine",
  "6" = "Large intestine/Colon"
)

# get the cleaned cluster
df$Cluster_clean <- gsub(" ", "", unlist(lapply(strsplit(as.character(df$Cluster), ":"), "[", 2)))

# remove the DE/VE from the cell type - not particularly necessary
# df$CellType_merge = gsub(":DE|:VE","",  as.character(df$CellType))

df[,"AP_pseudo"] <- clusterGroups[df$Cluster_clean]

df$AP_endoderm = unlist(lapply(strsplit(
  as.character(df$CellType), ":"), function(x) {
    if (length(x) < 2) {
      return(NA)
    } else {
      return(x[2])
    }
  }))

# everything that is not E8.75 set to NA
df[df$Timepoint != "E8.75","AP_pseudo"] <- NA

# everything that is not either DE or VE set to NA
df[is.na(df$AP_endoderm), "AP_pseudo"] <- NA



```

# Get counts and combine in sce

```{r get-counts}

counts = readRDS(paste0(root.dir , "External/Nowotschin_gut/counts.Rds"))
counts = t(counts)
sce = SingleCellExperiment( assays = list(counts = counts), colData = DataFrame(df))

sce$Sample <- gsub("_.*", "", colnames(sce))
now_samplesToKeep = unique(colData(sce)[!is.na(sce$AP_pseudo),"Sample"])
sce = sce[, sce$Sample %in% now_samplesToKeep]
sce = logNormCounts(sce)
saveRDS(sce , file = paste0(root.dir , "External/Nowotschin_gut/sce.Rds"))



```

# Session info

```{r sess-inf}
sessionInfo()
```