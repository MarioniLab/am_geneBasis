---
title: "Mapping to the atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
#Introduction & method

In this script we map cells from the FAS-affected embryos (+ 4 samples from the atlas experiment) onto our atlas.

```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(pheatmap)
library(reshape2)
library(edgeR)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
library(tibble)
library(plyr)
set.seed(32)

root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/core_functions.R"))


```


# Read counts

```{r load-counts, message = FALSE}


counts = read.table(paste0(root.dir, "data/scRNA_datasets/spleen/raw/raw_counts.txt"), sep = " ", header = F)
colnames(counts) = c("gene.num" , "cell.num" , "counts")
rownames.counts = read.table(paste0(root.dir, "data/scRNA_datasets/spleen/raw/rownames.txt"), sep = "\n", header = F) 
rownames.counts = data.frame(gene.num = c(1:nrow(rownames.counts)) , gene =  rownames.counts$V1 )
colnames.counts = read.table(paste0(root.dir, "data/scRNA_datasets/spleen/raw/colnames.txt"), sep = "\n", header = F)
colnames.counts = data.frame(cell.num = c(1:nrow(colnames.counts) ) , cell = colnames.counts$V1 )

counts = merge(counts , rownames.counts , by = "gene.num", all.x = T, all.y = F)
counts = merge(counts , colnames.counts , by = "cell.num", all.x = T, all.y = F)
counts = counts[, c("gene" , "cell" , "counts")]

counts = dcast(counts, gene ~ cell)
counts[is.na(counts)] <- 0

rownames(counts) <- counts$gene
counts = counts[,2:ncol(counts)]

counts = data.matrix(counts , rownames.force = NA)
counts <- as(counts, "dgTMatrix") 


genes = rownames(counts)
cells = colnames(counts)
counts = counts[order(rownames(counts)),]
counts = counts[, order(colnames(counts))]


```


# Metadata

```{r load-meta, message = FALSE}

cells = read.table(paste0(root.dir, "data/scRNA_datasets/spleen/raw/colnames.txt"), sep = "\n", header = F)
celltypes = read.table(paste0(root.dir, "data/scRNA_datasets/spleen/metadata/annotations.txt"), sep = "\n", header = F)
samples =  read.table(paste0(root.dir, "data/scRNA_datasets/spleen/metadata/batch.txt"), sep = "\n", header = F)
meta = data.frame(cell = cells$V1, sample = samples$V1 , celltype = celltypes$V1)
meta = meta[order(meta$cell),]


```

# Add logcounts

```{r add-logcounts, message = FALSE}



batchFactor = factor(meta$sample)
sce = lapply(unique(batchFactor) , function(current.batch){
  idx = which(batchFactor == current.batch)
  current.sce = SingleCellExperiment(assays = list("counts" = counts[,idx]), colData = meta[idx,])
  clusters <- quickCluster(current.sce, method="igraph", use.ranks=TRUE, d=50, min.mean=0.1)
  current.sce <- computeSumFactors(current.sce, clusters=clusters)
  return(current.sce)
})
sce = do.call(multiBatchNorm , sce )
sce = do.call(cbind, sce)


sce$cell = as.character(sce$cell)
sce$celltype = as.character(sce$celltype)
sce$sample = as.character(sce$sample)
saveRDS(sce, file = paste0(root.dir, "data/scRNA_datasets/spleen/sce_spleen_norm.Rds"))




```


#Session Info

```{r sessinf}
sessionInfo()
```
