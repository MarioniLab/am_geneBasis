---
title: "Gene selection."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

#Introduction & method


```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
library(BiocStyle)
library(stats)
ncores = 10
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)


#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir , "am_geneBasis/functions/main_functions.R"))


system = "spleen"
sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_denoised_" , system , ".Rds"))
meta = as.data.frame(colData(sce))


```

# Add z-scale and cosine normed 

```{r add-diff-normalisations, message = FALSE}


add_z_norm = function(sce , assay , batch = "sample"){
  counts = assay(sce , assay)
  if (is.null(batch)){
    counts_normed = t(apply(counts, 1 , function(x) scale(x)))
    idx = which(is.na(counts_normed))
    counts_normed[idx] = 0
    colnames(counts_normed) = colnames(counts)
  }
  else {
    meta = as.data.frame(colData(sce))
    batchFactor = factor(meta[, colnames(meta) == batch])
    counts_normed = lapply(unique(batchFactor) , function(current.batch){
      idx = which(batchFactor == current.batch)
      current.counts = counts[, idx]
      current.counts_normed = t(apply(current.counts, 1 , function(x) scale(x)))
      idx = which(is.na(current.counts_normed))
      current.counts_normed[idx] = 0
      colnames(current.counts_normed) = colnames(current.counts)

      return(current.counts_normed)
    })
    counts_normed = do.call(cbind , counts_normed)
    counts_normed = counts_normed[, match(colnames(sce) , colnames(counts_normed))]
  }
  return(counts_normed)
}


assay(sce , "z.logcounts") = add_z_norm(sce , assay = "logcounts" , batch = "sample")
assay(sce , "cosine.logcounts") = cosineNorm(assay(sce , "logcounts"))
assay(sce , "z.logcounts.denoised") = add_z_norm(sce , assay = "logcounts.denoised" , batch = "sample")
assay(sce , "cosine.logcounts.denoised") = cosineNorm(assay(sce , "logcounts.denoised"))



```

# Iterative gene search

```{r iterative-gene-search, message = FALSE}


add_genes = function(sce , stat = NULL, genes_base , assay = "logcounts", n_genes_total , batch , type){
  eps = 0.00001
  if (type %in% c("dist.l1" , "dist.l2")){
    ratio.type = "sub"
  } else if (type %in% c("KS")){
    ratio.type = "div"
  }
    
  if (is.null(stat)){
    stat = suppressWarnings( get_distr_dist(sce, genes = rownames(sce), assay = assay, batch = batch , n.neigh = 5 , nPC = 50 , genes.predict = rownames(sce) , type = type) )
    colnames(stat) = c("gene" , "dist.all")
  }
  genes_all = genes_base
  while(length(genes_all) < n_genes_total){
    stat_genes = suppressWarnings( get_distr_dist(sce , genes = genes_all , assay = assay , batch = batch, n.neigh = 5 , nPC = NULL , genes.predict = rownames(sce) , type = type) )
    colnames(stat_genes) = c("gene" , "dist")   
    stat_genes = stat_genes[!stat_genes$gene %in% genes_all , ] 
    stat_genes = merge(stat_genes , stat)
    
    if (ratio.type == "div"){
      stat_genes$dist.ratio = stat_genes$dist / stat_genes$dist.all 
    }
    else if (ratio.type == "sub"){
      stat_genes$dist.ratio = stat_genes$dist - stat_genes$dist.all 
    }  
    idx = which(stat_genes$dist.ratio == max(stat_genes$dist.ratio))
    gene = stat_genes$gene[idx[1]]
    genes_all = c(genes_all , as.character(gene))
  }
  out = genes_all
  return(out)
}


assays = c("logcounts" , "logcounts.denoised" , "z.logcounts" , "z.logcounts.denoised" , "cosine.logcounts" , "cosine.logcounts.denoised")
types = c("dist.l1" , "dist.l2" , "KS")
runs = c(1:2)
n_genes_total = 150
pars = lapply(assays , function(assay){
  pars.per_assay = lapply(types , function(type){
    pars.per_type = lapply(runs , function(run){
      out = data.frame(assay = assay , type = type , run = run)
      return(out)
    })
    pars.per_type = do.call(rbind , pars.per_type)
    return(pars.per_type)
  })
  pars.per_assay = do.call(rbind , pars.per_assay)
  return(pars.per_assay)
}) 
pars = do.call(rbind , pars)



genes_stat = bplapply(c(1:nrow(pars)) , function(i){
  genes_base = sample(rownames(sce) , 2)
  genes = add_genes(sce , stat = NULL, genes_base = genes_base, assay = pars$assay[i], n_genes_total = n_genes_total, batch = "sample", type = pars$type[i])
  saveRDS(genes , paste0(root.dir , "data/gene_selection/" , system , "/" , pars$assay[i] , "_" , pars$type[i] , "_", pars$run[i], ".Rds"))
  return(genes)
}, BPPARAM = mcparam)



```

#Session Info

```{r sessinf}
sessionInfo()
```
