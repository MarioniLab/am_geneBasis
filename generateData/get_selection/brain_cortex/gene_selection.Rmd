---
title: "Gene selection."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---

#Introduction & method


```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(reshape2)
library(edgeR)
library(ggplot2)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(dplyr)
library(BiocStyle)
library(stats)
ncores = 5
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
library(geneBasisR)
set.seed(32)

#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research/marioni/alsu/geneBasis/"

# only leave the ones w/ entries in seqfish
seqfish_cortex = readRDS("/nfs/research/marioni/alsu/External/seqFISH_plus/seqfish_cortex.Rds")

get_sce = function(dir, type){
  sce = readRDS(dir)
  
  if (type == "Zeisel"){
    sce = sce[ , !sce$Class %in% c("Blood" , "Excluded" , "Immune")]
    sce = sce[rownames(sce) %in% rownames(seqfish_cortex) , ]
    rowdata = rowData(sce)
    rownames(sce) = rowdata$Accession
    sce = retain_informative_genes(sce)
    rowdata = rowData(sce)
    rownames(sce) = rowdata$Gene
    sce = sce[!rownames(sce) %in% c("Zfand4") , ]
  }
  else {
    sce = sce[rownames(sce) %in% rownames(seqfish_cortex) , ]
    sce = retain_informative_genes(sce)
    sce = sce[!rownames(sce) %in% c("Zfand4") , ]
  }
  return(sce)
}


```

# Iterative gene search

```{r iterative-gene-search, message = FALSE}


dirs = c("Azimuth/mouse_motorcortex.rds" , "Zeisel_mouseBrain/cortex1.Rds" , "Zeisel_mouseBrain/cortex2.Rds" , 
         "Zeisel_mouseBrain/cortex3.Rds" , "Tasic_cortex/sce_brain_cortex.Rds")
names = c("cortex_azimuth" , "cortex_zeisel_1" , "cortex_zeisel_2" , "cortex_zeisel_3" , "cortex_tasic" )
batches = c("orig.ident" , "DonorID" , "DonorID" , "DonorID" )
types = c("Azimuth" , "Zeisel" , "Zeisel" , "Zeisel" , "Tasic")

n_genes_total = 250

genes = bplapply(1:length(dirs) , function(i){
  sce = get_sce(paste0("/nfs/research/marioni/alsu/External/" , dirs[i]) , types[i])
  if ( i < 5 ){
    current.genes = geneBasisR::gene_search(sce , genes_base = NULL, n_genes_total = n_genes_total, batch = batches[i], n.neigh = 5, nPC.all = 50, nPC.selection = 100, verbose = F)
  }
  else {
    current.genes = geneBasisR::gene_search(sce , genes_base = NULL, n_genes_total = n_genes_total, batch = NULL, n.neigh = 3, nPC.all = 50, nPC.selection = 50, verbose = F)
  }
  saveRDS(current.genes , paste0(root.dir , "data/gene_selection/" , "mouse_motorcortex" , "/" , "gene_selection_", names[i], ".Rds"))
  return(current.genes)
}, BPPARAM = mcparam)



```

#Session Info

```{r sessinf}
sessionInfo()
```
