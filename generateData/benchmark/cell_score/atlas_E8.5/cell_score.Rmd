---
title: "Pipeline to benchmark selections: geneBasis, SCMER, scGeneFit (marker selection) for cell score"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
# Load dependencies

```{r load, message = FALSE}


library(SingleCellExperiment)
library(batchelor)
library(stats)
library(BiocNeighbors)
library(tibble)
library(reshape2)
library(plyr)
library(dplyr)
library(scran)
library(batchelor)
library(stringr)
library(BiocSingular)
library(BiocParallel)
library(SingleCellExperiment)
library(BiocStyle)
ncores = 5
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
set.seed(32)

#root.dir = "/Users/alsu/Develop/geneBasis/"
root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
source(paste0(root.dir, "am_geneBasis/functions/main_functions.R"))

system = "atlas_E8.5"

# read sce 
sce = readRDS(paste0(root.dir , "data/scRNA_datasets/" , system , "/sce_" , system , ".Rds"))
sce = retain_only_hvgs(sce , n = 10000)

```


# Get gene selections

## geneBasis

```{r read-selection-gene-basis, message = FALSE}

genes_alsu = readRDS(paste0(root.dir , "data/gene_selection/" , system , "/" , "gene_selection.Rds"))
genes_alsu = as.character(genes_alsu$gene)

```

## SCMER

```{r read-selection-scmer, message = FALSE}


# batched
scmer_batched.files = list.files(path = paste0( root.dir , "data/scmer_res_selected/" , system , "/batched/" ))
n_genes = sapply(scmer_batched.files , function(str) str_replace_all(str,  ".txt" , ""))
n_genes = sapply(n_genes , function(str) str_replace_all(str,  "nGenes_" , ""))
n_genes = sort(as.numeric(n_genes))

genes_scmer_batched = lapply(n_genes , function(str){
  out = read.table(paste0( root.dir , "data/scmer_res_selected/" , system , "/batched/nGenes_" , str , ".txt") , header = F)
  genes = out$V1
  return(genes)
})

# unbatched
scmer_unbatched.files = list.files(path = paste0( root.dir , "data/scmer_res_selected/" , system , "/unbatched/" ))
n_genes = sapply(scmer_unbatched.files , function(str) str_replace_all(str,  ".txt" , ""))
n_genes = sapply(n_genes , function(str) str_replace_all(str,  "nGenes_" , ""))
n_genes = sort(as.numeric(n_genes))

genes_scmer_unbatched = lapply(n_genes , function(str){
  out = read.table(paste0( root.dir , "data/scmer_res_selected/" , system , "/unbatched/nGenes_" , str , ".txt") , header = F)
  genes = out$V1
  return(genes)
})


```

## scGene-Fit

```{r read-selection-scGene-Fit, message = FALSE}


option = "centers"

scgenefit_centers.files = list.files(path = paste0( root.dir , "data/scGeneFit_res/" , system , "/" , option , "/" ))
n_genes = sapply(scgenefit_centers.files , function(str) str_replace_all(str,  ".txt" , ""))
n_genes = sapply(n_genes , function(str) str_replace_all(str,  "nGenes_" , ""))
n_genes = sort(as.numeric(n_genes))

genes_scgenefit = lapply(n_genes , function(str){
  out = read.table(paste0( root.dir , "data/scGeneFit_res/" , system , "/" , option , "/nGenes_" , str , ".txt") , header = F)
  genes = out$V1
  return(genes)
})


```

# Neighborhood preservation score (per cell)

```{r neigh-all, message = FALSE}


samples = unique(sce$sample)

neighs.all = lapply(samples , function(sample){
  current.sce = sce[, sce$sample == sample]
  current.neighs.all = get_mapping(current.sce , genes = rownames(current.sce), batch = NULL, n.neigh = "all", nPC = 50 , get.dist = T , type = "together")
  distances = current.neighs.all$distances
  distances_scaled = t( apply(distances , 1 , function(x) scale(x)) )
  rownames(distances_scaled) = rownames(distances)
  current.neighs.all$distances = distances_scaled
  return(current.neighs.all)
})
names(neighs.all) = samples


```

## Alsu VS scmer-batched

```{r score-vs-scmer-batched, message = FALSE}


genes = lapply(1:length(genes_scmer_batched) , function(i){
  current.genes_scmer = genes_scmer_batched[[i]]
  n_genes = length(current.genes_scmer)
  out = list("alsu" = as.character(genes_alsu[1:n_genes]) , "scmer_batched" = as.character(current.genes_scmer) , "hvgs" = as.character(get_hvgs(sce,n=n_genes)), "random" = sample(rownames(sce) , n_genes))
  return(out)
})

stat_scmer_batched = bplapply(c(1:length(genes)) , function(i){
  current.genes = genes[[i]]
  stat.per_n_genes = lapply(1:length(current.genes) , function(j){
    stat.PC_50 = lapply(samples , function(sample){
      current.sce = sce[, sce$sample == sample]
      current.neighs.all = neighs.all[[which(names(neighs.all) = sample)]]
      current.stat = suppressWarnings( get_preservation_score_simple(current.sce , neighs.all = current.neighs.all , assay = "logcounts" , genes.all = rownames(current.sce) , 
                                  genes.compare = current.genes[[j]], batch = NULL, n.neigh = 5 , nPC.all = 50 , nPC.compare = 50) )
    })
    stat.PC_50 = do.call(rbind , stat.PC_50)
    stat.PC_50$nPC = 50
    
    
    stat.PC_all = lapply(samples , function(sample){
      current.sce = sce[, sce$sample == sample]
      current.neighs.all = neighs.all[[which(names(neighs.all) = sample)]]
      current.stat = suppressWarnings( get_preservation_score_simple(current.sce , neighs.all = current.neighs.all , assay = "logcounts" , genes.all = rownames(current.sce) , 
                                  genes.compare = current.genes[[j]], batch = NULL, n.neigh = 5 , nPC.all = 50 , nPC.compare = length(current.genes[[j]])-1) )
    })
    stat.PC_all = do.call(rbind , stat.PC_all)
    stat.PC_all$nPC = "all"
    
    current.stat = rbind(stat.PC_50, stat.PC_all)
    
    current.stat$type = names(current.genes)[j]
    current.stat$n_genes = length(current.genes[[j]])
    return(current.stat)
  })
  stat.per_n_genes = do.call(rbind , stat.per_n_genes)
  return(stat.per_n_genes)
}, BPPARAM = mcparam)
stat_scmer_batched = do.call(rbind , stat_scmer_batched)
saveRDS(stat_scmer_batched , file = paste0(root.dir , "data/benchmark/cell_score/" , system , "/cell_score__scmer_batched.Rds"))


```

## Alsu VS scmer-unbatched

```{r score-vs-scmer-unbatched, message = FALSE}


genes = lapply(1:length(genes_scmer_unbatched) , function(i){
  current.genes_scmer = genes_scmer_unbatched[[i]]
  n_genes = length(current.genes_scmer)
  out = list("alsu" = as.character(genes_alsu[1:n_genes]) , "scmer_batched" = as.character(current.genes_scmer) , "hvgs" = as.character(get_hvgs(sce,n=n_genes)), "random" = sample(rownames(sce) , n_genes))
  return(out)
})

stat_scmer_unbatched = bplapply(c(1:length(genes)) , function(i){
  current.genes = genes[[i]]
  stat.per_n_genes = lapply(1:length(current.genes) , function(j){
   stat.PC_50 = lapply(samples , function(sample){
      current.sce = sce[, sce$sample == sample]
      current.neighs.all = neighs.all[[which(names(neighs.all) = sample)]]
      current.stat = suppressWarnings( get_preservation_score_simple(current.sce , neighs.all = current.neighs.all , assay = "logcounts" , genes.all = rownames(current.sce) , 
                                  genes.compare = current.genes[[j]], batch = NULL, n.neigh = 5 , nPC.all = 50 , nPC.compare = 50) )
    })
    stat.PC_50 = do.call(rbind , stat.PC_50)
    stat.PC_50$nPC = 50
    
    
    stat.PC_all = lapply(samples , function(sample){
      current.sce = sce[, sce$sample == sample]
      current.neighs.all = neighs.all[[which(names(neighs.all) = sample)]]
      current.stat = suppressWarnings( get_preservation_score_simple(current.sce , neighs.all = current.neighs.all , assay = "logcounts" , genes.all = rownames(current.sce) , 
                                  genes.compare = current.genes[[j]], batch = NULL, n.neigh = 5 , nPC.all = 50 , nPC.compare = length(current.genes[[j]])-1) )
    })
    stat.PC_all = do.call(rbind , stat.PC_all)
    stat.PC_all$nPC = "all"
    
    current.stat = rbind(stat.PC_50, stat.PC_all)
    
    current.stat$type = names(current.genes)[j]
    current.stat$n_genes = length(current.genes[[j]])
    return(current.stat)
  })
  stat.per_n_genes = do.call(rbind , stat.per_n_genes)
  return(stat.per_n_genes)
}, BPPARAM = mcparam)
stat_scmer_unbatched = do.call(rbind , stat_scmer_unbatched)
saveRDS(stat_scmer_unbatched , file = paste0(root.dir , "data/benchmark/cell_score/" , system , "/cell_score__scmer_unbatched.Rds"))


```

## Alsu VS scGeneFit

```{r score-vs-scgenefit, message = FALSE}


genes = lapply(1:length(genes_scgenefit) , function(i){
  current.genes_scgenefit = genes_scgenefit[[i]]
  n_genes = length(current.genes_scgenefit)
  out = list("alsu" = as.character(genes_alsu[1:n_genes]) , "scmer_batched" = as.character(current.genes_scmer) , "hvgs" = as.character(get_hvgs(sce,n=n_genes)), "random" = sample(rownames(sce) , n_genes))
  return(out)
})

stat_scgenefit = bplapply(c(1:length(genes)) , function(i){
  current.genes = genes[[i]]
  stat.per_n_genes = lapply(1:length(current.genes) , function(j){
    stat.PC_50 = lapply(samples , function(sample){
      current.sce = sce[, sce$sample == sample]
      current.neighs.all = neighs.all[[which(names(neighs.all) = sample)]]
      current.stat = suppressWarnings( get_preservation_score_simple(current.sce , neighs.all = current.neighs.all , assay = "logcounts" , genes.all = rownames(current.sce) , 
                                  genes.compare = current.genes[[j]], batch = NULL, n.neigh = 5 , nPC.all = 50 , nPC.compare = 50) )
    })
    stat.PC_50 = do.call(rbind , stat.PC_50)
    stat.PC_50$nPC = 50
    
    
    stat.PC_all = lapply(samples , function(sample){
      current.sce = sce[, sce$sample == sample]
      current.neighs.all = neighs.all[[which(names(neighs.all) = sample)]]
      current.stat = suppressWarnings( get_preservation_score_simple(current.sce , neighs.all = current.neighs.all , assay = "logcounts" , genes.all = rownames(current.sce) , 
                                  genes.compare = current.genes[[j]], batch = NULL, n.neigh = 5 , nPC.all = 50 , nPC.compare = length(current.genes[[j]])-1) )
    })
    stat.PC_all = do.call(rbind , stat.PC_all)
    stat.PC_all$nPC = "all"
    
    current.stat = rbind(stat.PC_50, stat.PC_all)
    
    current.stat$type = names(current.genes)[j]
    current.stat$n_genes = length(current.genes[[j]])
    return(current.stat)
  })
  stat.per_n_genes = do.call(rbind , stat.per_n_genes)
  return(stat.per_n_genes)
}, BPPARAM = mcparam)
stat_scgenefit = do.call(rbind , stat_scgenefit)
saveRDS(stat_scgenefit , file = paste0(root.dir , "data/benchmark/cell_score/" , system , "/cell_score__scgenefit.Rds"))


```


# Session Info

```{r sessinf}
sessionInfo()
```
