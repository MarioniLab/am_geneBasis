---
title: "Mapping to the atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
---
#Introduction & method

In this script we map cells from the FAS-affected embryos (+ 4 samples from the atlas experiment) onto our atlas.

```{r load, message = FALSE}
# load libraries we are going to use

library(Matrix)
library(scran)
library(scater)
library(batchelor)
library(knitr)
library(pheatmap)
library(reshape2)
library(edgeR)
library(MouseGastrulationData)
library(BiocSingular)
library(BiocParallel)
library(BiocNeighbors)
library(SingleCellExperiment)
library(tibble)
library(viridis)
library(dplyr)

set.seed(32)


root.dir = "/nfs/research1/marioni/alsu/geneBasis/"
#root.dir = "/Users/alsu/Develop/geneBasis/"
source(paste0(root.dir, "am_geneBasis/core_functions.R"))
sce.atlas = readRDS(paste0( root.dir, "data/atlas__8_5/sce_atlas_8.5.Rds"))

# work with just one sample for now - quicker
sce.atlas = sce.atlas[, sce.atlas$sample == 29]
# delete very rare CTs for now
tab = table(sce.atlas$celltype)
CTs.2keep = names(tab)[tab >= 20]
sce.atlas = sce.atlas[, sce.atlas$celltype %in% CTs.2keep]  
counts.atlas = as.matrix(logcounts(sce.atlas))
meta.atlas = as.data.frame(colData(sce.atlas))


```


# Marker detection 

```{r findMarkers-atlas, message = FALSE}


lfc.thresh = 0.5
FDR.thresh = 0.05

markers = lapply(unique(meta.atlas$celltype), function(CT){
  print(CT)
  current.markers = findMarkers( sce.atlas , sce.atlas$celltype %in% CT, lfc = lfc.thresh, direction = "up", assay.type="logcounts")
  current.markers = as.data.frame( current.markers[[2]] )                
  idx = current.markers$FDR < FDR.thresh
  if (sum(idx) > 0){
    current.markers = current.markers[current.markers$FDR < FDR.thresh , ]
    current.markers = current.markers[, c("FDR", "logFC.FALSE")]
    colnames(current.markers) = c("FDR", "lfc")
    current.markers = rownames_to_column(current.markers, var = "external_gene_name")
    current.markers$celltype = CT
    return(current.markers)
  }
})
markers = do.call(rbind, markers)

# save it
write.table(markers, file = paste0(root.dir, "data/markers/markers__atlas_E8_5.tab"), row.names = F, col.names = T, quote = F, sep = "\t")

```


# Assign discrimanatory capacity 

To assign discriminatory capacity for each marker separately - we will map all cells using only this marker (R1 space) - and see how often we get the celltype of interest wring

```{r discriminatory-capacity-markers, message = FALSE}


unq.samples = unique(sce.atlas$sample)
n.neigh = 21

discriminatoryCapacityMarker = function(celltype , gene){
  current.counts.atlas = data.frame( cell = colnames(sce.atlas) , 
                                     counts = counts.atlas[gene,] , 
                                     celltype.actual = sce.atlas$celltype == celltype)
  current.counts.atlas$celltype.mapped = FALSE
  idx = current.counts.atlas$counts > 0
  current.knns = queryKNN( current.counts.atlas$counts, current.counts.atlas$counts[idx], k = n.neigh, 
                           get.index = TRUE, get.distance = FALSE)
  cells.mapped = t( apply(current.knns$index, 1, function(x) current.counts.atlas$cell[x[2:n.neigh]]) )
  celltypes = t(apply(cells.mapped, 1, function(x) meta.atlas$celltype[match(x, meta.atlas$cell)]))
  celltype.mapped = apply(celltypes, 1, function(x) getmode(x, 1:length(x)))
  celltype.mapped = celltype.mapped == celltype
  current.counts.atlas$celltype.mapped[idx] = celltype.mapped
  
  sensitivity = ( sum(current.counts.atlas$celltype.actual == T & current.counts.atlas$celltype.mapped == T ) )/
    (sum(current.counts.atlas$celltype.mapped == T))
  specificity = ( sum(current.counts.atlas$celltype.actual == F & current.counts.atlas$celltype.mapped == F ) )/
    (sum(current.counts.atlas$celltype.mapped == F))
  out = list(sensitivity = sensitivity, specificity = specificity)
  return(out)
}


```

# Add mean, cv and explnatory capacity

```{r add-explanatory-capacity, message = FALSE}


add_Mean_CV = function(celltype , gene){
  idx = sce.atlas$celltype == celltype
  current.counts = data.frame(cell = colnames(sce.atlas)[idx] , 
                              counts = counts.atlas[gene , idx],
                              sample = sce.atlas$sample[idx] ) 
  current.stat = as.data.frame( current.counts %>% group_by(sample) %>%
                                         dplyr::summarise(mean = mean(counts),
                                                          sd = sd(counts) , 
                                                          cv = sd(counts)/mean(counts) ))
  out = list(mean = mean(current.stat$mean, na.rm = T),
             sd = mean(current.stat$sd, na.rm = T),
             cv = mean(current.stat$cv, na.rm = T))
  return(out)
}


```

# Assign the scores and save

```{r combine-together, message = FALSE}


markers = lapply(1:nrow(markers), function(i){
  print(i)
  current.markers = markers[i,]
  discriminatory.capacity = discriminatoryCapacityMarker(current.markers$celltype[1] , current.markers$external_gene_name[1])
  current.markers$sensitivity[1] = discriminatory.capacity$sensitivity
  current.markers$specificity[1] = discriminatory.capacity$specificity
  
  parameters.distr = add_Mean_CV(current.markers$celltype[1] , current.markers$external_gene_name[1])
  current.markers$mean[1] = parameters.distr$mean
  current.markers$sd[1] = parameters.distr$sd
  current.markers$cv[1] = parameters.distr$cv
  
  return(current.markers)
})
markers = do.call(rbind, markers)


# save it
write.table(markers, file = paste0(root.dir, "data/markers/markers__atlas_E8_5.tab"), row.names = F, col.names = T, quote = F, sep = "\t")


```


#Session Info

```{r sessinf}
sessionInfo()
```
